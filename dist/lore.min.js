"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Enum(e){var t=Object.keys(e).reduce(function(t,o){return t[e[o]]=o,t},{});return Object.freeze(Object.keys(e).reduce(function(t,o){return t[o]=e[o],t},function(e){return t[e]}))}var _createClass=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),Lore={Version:"1.0.0"};"function"==typeof define&&define.amd?define("lore",Lore):"undefined"!=typeof exports&&"undefined"!=typeof module&&(module.exports=Lore),Lore.Mouse=Enum({Left:0,Middle:1,Right:2}),Lore.Keyboard=Enum({Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Esc:27}),Lore.Shaders={},Lore.getShader=function(e){return Lore.Shaders[e].clone()},Lore.init=function(e,t){this.opts=Lore.Utils.extend(!0,Lore.defaults,t);var o=(new Lore.UI(e),Lore.Color.fromHex(this.opts.clearColor)),n=new Lore.Renderer(e,{clearColor:o,verbose:!0,fps:document.getElementById("fps"),center:new Lore.Vector3f(125,125,125),antialiasing:this.opts.antialiasing});n.controls.limitRotationToHorizon(this.opts.limitRotationToHorizon);new Lore.CoordinatesHelper(n,"Coordinates","coordinates",{position:new Lore.Vector3f(0,0,0),axis:{x:{length:250,color:Lore.Color.fromHex("#222222")},y:{length:250,color:Lore.Color.fromHex("#222222")},z:{length:250,color:Lore.Color.fromHex("#222222")}},ticks:{x:{length:10,color:Lore.Color.fromHex("#1f1f1f")},y:{length:10,color:Lore.Color.fromHex("#1f1f1f")},z:{length:10,color:Lore.Color.fromHex("#1f1f1f")}},box:{enabled:!0,x:{color:Lore.Color.fromHex("#222222")},y:{color:Lore.Color.fromHex("#222222")},z:{color:Lore.Color.fromHex("#222222")}}});return n.render=function(e,t){for(var o in t)t[o].draw(n)},n},Lore.defaults={clearColor:"#121212",limitRotationToHorizon:!1,antialiasing:!1},Lore.DrawModes={points:0,lines:1,lineStrip:2,lineLoop:3,triangles:4,traingleStrip:5,triangleFan:6},Lore.Color=function(){function e(t,o,n,i){_classCallCheck(this,e),1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=o||0,this.components[2]=n||0,this.components[3]=i||1)}return _createClass(e,[{key:"set",value:function(e,t,o,n){this.components[0]=e,this.components[1]=t,this.components[2]=o,4==arguments.length&&(this.components[3]=n)}}],[{key:"fromHex",value:function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,o,n){return t+t+o+o+n+n});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e),o=parseInt(t[1],16),n=parseInt(t[2],16),i=parseInt(t[3],16);return t?new Lore.Color(o/255,n/255,i/255,1):null}},{key:"hueToRgb",value:function(e,t,o){if(o<0)o+=1;else if(o>1)o-=1;else{if(o<.1667)return e+6*(t-e)*o;if(o<.5)return t;if(o<.6667)return e+(t-e)*(.6667-o)*6}return e}},{key:"hslToRgb",value:function(e,t,o){var n=void 0,i=void 0,s=void 0;if(0==t)n=i=s=o;else{var r=o<.5?o*(1+t):o+t-o*t,a=2*o-r;n=Lore.Color.hueToRgb(a,r,e+.3333),i=Lore.Color.hueToRgb(a,r,e),s=Lore.Color.hueToRgb(a,r,e-.3333)}return[n,i,s]}},{key:"rgbToHsl",value:function(e,t,o){e/=255,t/=255,o/=255;var n=Math.max(e,t,o),i=Math.min(e,t,o),s=void 0,r=void 0,a=(n+i)/2;if(n==i)s=r=0;else{var c=n-i;switch(r=a>.5?c/(2-n-i):c/(n+i),n){case e:s=(t-o)/c+(t<o?6:0);break;case t:s=(o-e)/c+2;break;case o:s=(e-t)/c+4}s/=6}return[s,r,a]}},{key:"gdbHueShift",value:function(e){return e=.85*e+.66,e>1&&(e-=1),e=1-e+.33,e>1&&(e-=1),e}}]),e}(),Lore.Renderer=function(){function e(t,o){_classCallCheck(this,e),this.defaults={antialiasing:!0,verbose:!1,fpsElement:document.getElementById("fps"),clearColor:Lore.Color.fromHex("#000000"),clearDepth:1,center:new Lore.Vector3f,enableDepthTest:!0},this.opts=Lore.Utils.extend(!0,this.defaults,o),this.canvas=document.getElementById(t),this.parent=this.canvas.parentElement,this.fps=0,this.fpsCount=0,this.maxFps=1e3/30,this.devicePixelRatio=this.getDevicePixelRatio(),this.camera=new Lore.OrthographicCamera(this.getWidth()/-2,this.getWidth()/2,this.getHeight()/2,this.getHeight()/-2),this.geometries={},this.ready=!1,this.gl=null,this.render=function(e,t){},this.effect=null,this.lastTiming=performance.now(),this.canvas.addEventListener("contextmenu",function(e){if(2===e.button)return e.preventDefault(),!1});var n=this;n.init();var i=o.center?o.center:new Lore.Vector3f;n.controls=o.controls||new Lore.OrbitalControls(n,1200,i)}return _createClass(e,[{key:"init",value:function(){var e=this,t={antialias:this.opts.antialiasing};if(this.gl=this.canvas.getContext("webgl",t)||this.canvas.getContext("experimental-webgl",t),!this.gl)return void console.error("Could not initialize the WebGL context.");var o=this.gl;if(console.log(o.getParameter(o.ALIASED_LINE_WIDTH_RANGE)),this.opts.verbose){var n=o.getContextAttributes().antialias,i=o.getParameter(o.SAMPLES);console.info("Antialiasing: "+n+" ("+i+"x)");var s=o.getShaderPrecisionFormat(o.FRAGMENT_SHADER,o.HIGH_FLOAT),r=0!=s.precision;console.info("High precision support: "+r)}var a="OES_standard_derivatives";null===o.getExtension(a)&&console.warn("Could not load extension: "+a+".");var c="WEBGL_draw_buffers";null===o.getExtension(c)&&console.warn("Could not load extension: "+c+".");var u="WEBGL_depth_texture";null===o.getExtension(u)&&console.warn("Could not load extension: "+u+"."),this.setClearColor(this.opts.clearColor),o.clearDepth(this.opts.clearDepth),this.opts.enableDepthTest&&(o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL),this.opts.verbose&&console.log("enable depth test")),setTimeout(function(){e.updateViewport(0,0,e.getWidth(),e.getHeight())},1e3),this.updateViewport(0,0,e.getWidth(),e.getHeight()),window.addEventListener("resize",function(t){var o=e.getWidth(),n=e.getHeight();e.updateViewport(0,0,o,n)}),this.effect=new Lore.Effect(this,"fxaaEffect"),this.ready=!0,this.animate()}},{key:"setClearColor",value:function(e){this.opts.clearColor=e;var t=this.opts.clearColor.components;this.gl.clearColor(t[0],t[1],t[2],t[3])}},{key:"getWidth",value:function(){return this.canvas.offsetWidth}},{key:"getHeight",value:function(){return this.canvas.offsetHeight}},{key:"updateViewport",value:function(e,t,o,n){this.canvas.width=o,this.canvas.height=n,this.gl.viewport(e,t,o,n),this.camera.left=-o/2,this.camera.right=o/2,this.camera.top=n/2,this.camera.bottom=-n/2,this.camera.updateProjectionMatrix(),this.effect=new Lore.Effect(this,"fxaaEffect"),this.effect.shader.uniforms.resolution.setValue([o,n])}},{key:"animate",value:function(){var e=this;if(setTimeout(function(){requestAnimationFrame(function(){e.animate()})},this.maxFps),this.opts.fpsElement){var t=performance.now(),o=t-this.lastTiming;this.lastTiming=t,this.fpsCount<10?(this.fps+=Math.round(1e3/o),this.fpsCount++):(this.opts.fpsElement.innerHTML=Math.round(this.fps/this.fpsCount),this.fpsCount=0,this.fps=0)}this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.render(this.camera,this.geometries),this.camera.isProjectionMatrixStale=!1,this.camera.isViewMatrixStale=!1}},{key:"createGeometry",value:function(e,t){var o=Lore.getShader(t);o.init(this.gl);var n=new Lore.Geometry(e,this.gl,o);return this.geometries[e]=n,n}},{key:"setMaxFps",value:function(e){this.maxFps=1e3/e}},{key:"getDevicePixelRatio",value:function(){return window.devicePixelRatio||1}}]),e}(),Lore.Shader=function(){function e(t,o,n,i){_classCallCheck(this,e),this.name=t,this.uniforms=o||{},this.vertexShader=n||[],this.fragmentShader=i||[],this.gl=null,this.program=null,this.initialized=!1,this.lastTime=(new Date).getTime(),this.uniforms.modelViewMatrix=new Lore.Uniform("modelViewMatrix",(new Lore.Matrix4f).entries,"float_mat4"),this.uniforms.projectionMatrix=new Lore.Uniform("projectionMatrix",(new Lore.Matrix4f).entries,"float_mat4")}return _createClass(e,[{key:"clone",value:function(){return new Lore.Shader(this.name,this.uniforms,this.vertexShader,this.fragmentShader)}},{key:"getVertexShaderCode",value:function(){return this.vertexShader.join("\n")}},{key:"getFragmentShaderCode",value:function(){return this.fragmentShader.join("\n")}},{key:"getVertexShader",value:function(e){var t=e.createShader(e.VERTEX_SHADER),o="uniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\n\n"+this.getVertexShaderCode();return e.shaderSource(t,o),e.compileShader(t),Lore.Shader.showCompilationInfo(e,t,this.name,"Vertex Shader"),t}},{key:"getFragmentShader",value:function(e){var t=e.createShader(e.FRAGMENT_SHADER),o="#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n\n#ifdef GL_ES\nprecision highp float;\n#endif\n\n"+this.getFragmentShaderCode();return e.shaderSource(t,o),e.compileShader(t),Lore.Shader.showCompilationInfo(e,t,this.name,"Fragment Shader"),t}},{key:"init",value:function(e){this.gl=e,this.program=this.gl.createProgram();var t=this.getVertexShader(this.gl),o=this.getFragmentShader(this.gl);return t&&o?(this.gl.attachShader(this.program,t),this.gl.attachShader(this.program,o),this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)?void(this.initialized=!0):(console.error("Could not link program.\nVALIDATE_STATUS: "+this.gl.getProgramParameter(program,this.gl.VALIDATE_STATUS)+"\nERROR: "+this.gl.getError()),null)):(console.error("Failed to create the fragment or the vertex shader."),null)}},{key:"updateUniforms",value:function(e){if(this.uniforms.time){var t=this.uniforms.time,o=(new Date).getTime();t.value+=o-this.lastTime,this.lastTime=o,Lore.Uniform.Set(this.gl,this.program,t),t.stale=!1}for(var n in this.uniforms){var i=this.uniforms[n];i.stale&&Lore.Uniform.Set(this.gl,this.program,i)}}},{key:"use",value:function(){this.gl.useProgram(this.program),this.updateUniforms()}}],[{key:"showCompilationInfo",value:function(e,t,o,n){n=n||"Shader",e.getShaderParameter(t,e.COMPILE_STATUS)===!1&&console.error(n+" "+o+" did not compile."),""!==e.getShaderInfoLog(t)&&console.warn(n+" "+o+" info log: "+e.getShaderInfoLog(t))}}]),e}(),Lore.Uniform=function(){function e(t,o,n){_classCallCheck(this,e),this.name=t,this.value=o,this.type=n,this.stale=!0}return _createClass(e,[{key:"setValue",value:function(e){this.value=e,this.stale=!0}}],[{key:"Set",value:function(e,t,o){var n=e.getUniformLocation(t,o.name);"int"===o.type?e.uniform1i(n,o.value):"int_vec2"===o.type?e.uniform2iv(n,o.value):"int_vec3"===o.type?e.uniform3iv(n,o.value):"int_vec4"===o.type?e.uniform4iv(n,o.value):"int_array"===o.type?e.uniform1iv(n,o.value):"float"===o.type?e.uniform1f(n,o.value):"float_vec2"===o.type?e.uniform2fv(n,o.value):"float_vec3"===o.type?e.uniform3fv(n,o.value):"float_vec4"===o.type?e.uniform4fv(n,o.value):"float_array"===o.type?e.uniform1fv(n,o.value):"float_mat2"===o.type?e.uniformMatrix2fv(n,!1,o.value):"float_mat3"===o.type?e.uniformMatrix3fv(n,!1,o.value):"float_mat4"===o.type&&e.uniformMatrix4fv(n,!1,o.value),o.stale=!0}}]),e}(),Lore.Node=function(){function e(){_classCallCheck(this,e),this.type="Lore.Node",this.id=Lore.Node.createGUID(),this.isVisible=!0,this.position=new Lore.Vector3f,this.rotation=new Lore.Quaternion,this.scale=new Lore.Vector3f(1,1,1),this.up=new Lore.Vector3f(0,1,0),this.normalMatrix=new Lore.Matrix3f,this.modelMatrix=new Lore.Matrix4f,this.isStale=!1,this.children=new Array,this.parent=null}return _createClass(e,[{key:"applyMatrix",value:function(e){return this.modelMatrix.multiplyB(e),this}},{key:"getUpVector",value:function(){return new Lore.Vector3f(0,1,0).applyQuaternion(this.rotation)}},{key:"getForwardVector",value:function(){return new Lore.Vector3f(0,0,1).applyQuaternion(this.rotation)}},{key:"getRightVector",value:function(){return new Lore.Vector3f(1,0,0).applyQuaternion(this.rotation)}},{key:"translateOnAxis",value:function(e,t){var o=new Lore.Vector3f(e.components[0],e.components[1],e.components[2]);return o.applyQuaternion(this.rotation),o.multiplyScalar(t),this.position.add(o),this}},{key:"translateX",value:function(e){return this.position.components[0]=this.position.components[0]+e,this}},{key:"translateY",value:function(e){return this.position.components[1]=this.position.components[1]+e,this}},{key:"translateZ",value:function(e){return this.position.components[2]=this.position.components[2]+e,this}},{key:"setTranslation",value:function(e){return this.position=e,this}},{key:"setRotation",value:function(e,t){return this.rotation.setFromAxisAngle(e,t),this}},{key:"rotate",value:function(e,t){var o=new Lore.Quaternion(e,t);return this.rotation.multiplyA(o),this}},{key:"rotateX",value:function(e){return this.rotation.rotateX(e),this}},{key:"rotateY",value:function(e){return this.rotation.rotateY(e),this}},{key:"rotateZ",value:function(e){return this.rotation.rotateZ(e),this}},{key:"getRotationMatrix",value:function(){return this.rotation.toRotationMatrix()}},{key:"update",value:function(){return this.modelMatrix.compose(this.position,this.rotation,this.scale),this.isStale=!0,this}},{key:"getModelMatrix",value:function(){return this.modelMatrix.entries}}],[{key:"createGUID",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}}]),e}(),Lore.Geometry=function(e){function t(e,o,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.type="Lore.Geometry",i.name=e,i.gl=o,i.shader=n,i.attributes={},i.drawMode=i.gl.POINTS,i.isVisible=!0,i}return _inherits(t,e),_createClass(t,[{key:"addAttribute",value:function(e,t,o){return this.attributes[e]=new Lore.Attribute(t,o,e),this.attributes[e].createBuffer(this.gl,this.shader.program),this}},{key:"updateAttribute",value:function(e,t){return t&&(this.attributes[e].data=t),this.attributes[e].update(this.gl),this}},{key:"getAttribute",value:function(e){return this.attributes[e]}},{key:"removeAttribute",value:function(e){return delete this.attributes[e],this}},{key:"setMode",value:function(e){switch(e){case Lore.DrawModes.points:this.drawMode=this.gl.POINTS;break;case Lore.DrawModes.lines:this.drawMode=this.gl.LINES;break;case Lore.DrawModes.lineStrip:this.drawMode=this.gl.LINE_STRIP;break;case Lore.DrawModes.lineLoop:this.drawMode=this.gl.LINE_LOOP;break;case Lore.DrawModes.triangles:this.drawMode=this.gl.TRIANGLES;break;case Lore.DrawModes.triangleStrip:this.drawMode=this.gl.TRIANGLE_STRIP;break;case Lore.DrawModes.triangleFan:this.drawMode=this.gl.TRIANGLE_FAN}return this}},{key:"size",value:function(){return Object.keys(this.attributes).length>0?this.attributes[Object.keys(this.attributes)[0]].size:0}},{key:"draw",value:function(e){if(this.isVisible){for(var t in this.attributes)this.attributes[t].stale&&this.attributes[t].update(this.gl);if(this.shader.use(),e.camera.isProjectionMatrixStale&&this.shader.uniforms.projectionMatrix.setValue(e.camera.getProjectionMatrix()),e.camera.isViewMatrixStale){var o=Lore.Matrix4f.multiply(e.camera.viewMatrix,this.modelMatrix);this.shader.uniforms.modelViewMatrix.setValue(o.entries)}this.shader.updateUniforms();for(var n in this.attributes)this.attributes[n].bind(this.gl);this.gl.drawArrays(this.drawMode,0,this.size())}}}]),t}(Lore.Node),Lore.Attribute=function(){function e(t,o,n){_classCallCheck(this,e),this.type="Lore.Attribute",this.data=t,this.attributeLength=o||3,this.name=n,this.size=this.data.length/this.attributeLength,this.buffer=null,this.attributeLocation,this.bufferType=null,this.drawMode=null,this.stale=!1}return _createClass(e,[{key:"setFromVector",value:function(e,t){this.data.set(t.components,e*this.attributeLength,t.components.length)}},{key:"setFromVectorArray",value:function(e){if(this.attributeLength!==e[0].components.length)throw"The attribute has a length of "+this.attributeLength+". But the vectors have "+e[0].components.length+" components.";for(var t=0;t<e.length;t++)this.data.set(e[t].components,t*this.attributeLength,e[t].components.length)}},{key:"getX",value:function(e){return this.data[e*this.attributeLength]}},{key:"setX",value:function(e,t){this.data[e*this.attributeLength]}},{key:"getY",value:function(e){return this.data[e*this.attributeLength+1]}},{key:"setY",value:function(e,t){this.data[e*this.attributeLength+1]}},{key:"getZ",value:function(e){return this.data[e*this.attributeLength+2]}},{key:"setZ",value:function(e,t){this.data[e*this.attributeLength+2]}},{key:"getW",value:function(e){return this.data[e*this.attributeLength+3]}},{key:"setW",value:function(e,t){this.data[e*this.attributeLength+3]}},{key:"getGlType",value:function(e){return e.FLOAT}},{key:"update",value:function(e){e.bindBuffer(this.bufferType,this.buffer),e.bufferData(this.bufferType,this.data,this.drawMode),this.stale=!1}},{key:"createBuffer",value:function(e,t,o,n){this.buffer=e.createBuffer(),this.bufferType=o||e.ARRAY_BUFFER,this.drawMode=n||e.STATIC_DRAW,e.bindBuffer(this.bufferType,this.buffer),e.bufferData(this.bufferType,this.data,this.drawMode),this.buffer.itemSize=this.attributeLength,this.buffer.numItems=this.size,this.attributeLocation=e.getAttribLocation(t,this.name),e.bindBuffer(this.bufferType,null)}},{key:"bind",value:function(e){e.bindBuffer(this.bufferType,this.buffer),this.attributeLocation>=0&&(e.vertexAttribPointer(this.attributeLocation,this.attributeLength,this.getGlType(e),e.FALSE,0,0),e.enableVertexAttribArray(this.attributeLocation))}}]),e}(),Lore.Effect=function(){function e(t,o){_classCallCheck(this,e),this.renderer=t,this.gl=this.renderer.gl,this.framebuffer=this.initFramebuffer(),this.texture=this.initTexture(),this.renderbuffer=this.initRenderbuffer(),this.shader=Lore.getShader(o),this.shader.init(this.renderer.gl),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}return _createClass(e,[{key:"initBuffer",value:function(){var e=this.gl,t=e.getAttribLocation(this.shader.program,"v_coord"),o=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,1,-1,1,-1,-1,-1,-1,1,-1,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),o}},{key:"initTexture",value:function(){var e=this.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.renderer.getWidth(),this.renderer.getHeight(),0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),t}},{key:"initFramebuffer",value:function(){var e=this.gl,t=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,t),t}},{key:"initRenderbuffer",value:function(){var e=this.gl,t=e.createRenderbuffer();return e.bindRenderbuffer(e.RENDERBUFFER,t),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.renderer.getWidth(),this.renderer.getHeight()),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t),t}},{key:"bind",value:function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}},{key:"unbind",value:function(){var e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),this.initBuffer(),this.shader.use(),e.drawArrays(e.TRIANGLES,0,6)}}]),e}(),Lore.ControlsBase=function(){function e(t){_classCallCheck(this,e),this.renderer=t,this.canvas=t.canvas,this.lowFps=15,this.highFps=30,this.eventListeners={},this.renderer.setMaxFps(this.lowFps),this.touchMode="drag",this.mouse={previousPosition:{x:null,y:null},delta:{x:0,y:0},position:{x:0,y:0},state:{left:!1,middle:!1,right:!1},normalizedPosition:{x:0,y:0},touches:0},this.keyboard={alt:!1,ctrl:!1,shift:!1};var o=this;this.canvas.addEventListener("mousemove",function(e){(null!==o.mouse.previousPosition.x&&o.mouse.state.left||o.mouse.state.middle||o.mouse.state.right)&&(o.mouse.delta.x=e.pageX-o.mouse.previousPosition.x,o.mouse.delta.y=e.pageY-o.mouse.previousPosition.y,o.mouse.position.x+=.01*o.mouse.delta.x,o.mouse.position.y+=.01*o.mouse.delta.y,o.mouse.state.left?o.raiseEvent("mousedrag",{e:o.mouse.delta,source:"left"}):o.mouse.state.middle?o.raiseEvent("mousedrag",{e:o.mouse.delta,source:"middle"}):o.mouse.state.right&&o.raiseEvent("mousedrag",{e:o.mouse.delta,source:"right"}));var t=o.canvas.getBoundingClientRect();o.mouse.normalizedPosition.x=(e.clientX-t.left)/o.canvas.width*2-1,o.mouse.normalizedPosition.y=2*-((e.clientY-t.top)/o.canvas.height)+1,o.raiseEvent("mousemove",{e:o}),o.mouse.previousPosition.x=e.pageX,o.mouse.previousPosition.y=e.pageY}),this.canvas.addEventListener("touchstart",function(e){o.mouse.touches++;var t=e.touches[0];e.preventDefault(),o.mouse.touched=!0,o.renderer.setMaxFps(o.highFps);var n=o.canvas.getBoundingClientRect();o.mouse.normalizedPosition.x=(t.clientX-n.left)/o.canvas.width*2-1,o.mouse.normalizedPosition.y=2*-((t.clientY-n.top)/o.canvas.height)+1,"drag"!==o.touchMode&&o.raiseEvent("mousemove",{e:o}),o.raiseEvent("mousedown",{e:o,source:"touch"})}),this.canvas.addEventListener("touchend",function(e){o.mouse.touches--,e.preventDefault(),o.mouse.touched=!1,o.mouse.previousPosition.x=null,o.mouse.previousPosition.y=null,o.renderer.setMaxFps(o.lowFps),o.raiseEvent("mouseup",{e:o,source:"touch"})}),this.canvas.addEventListener("touchmove",function(e){var t=e.touches[0],n="left";2==o.mouse.touches&&(n="right"),e.preventDefault(),console.log(t.pageX,t.pageY),null!==o.mouse.previousPosition.x&&o.mouse.touched&&(o.mouse.delta.x=t.pageX-o.mouse.previousPosition.x,o.mouse.delta.y=t.pageY-o.mouse.previousPosition.y,o.mouse.position.x+=.01*o.mouse.delta.x,o.mouse.position.y+=.01*o.mouse.delta.y,"drag"===o.touchMode&&o.raiseEvent("mousedrag",{e:o.mouse.delta,source:n}));var i=o.canvas.getBoundingClientRect();o.mouse.normalizedPosition.x=(t.clientX-i.left)/o.canvas.width*2-1,o.mouse.normalizedPosition.y=2*-((t.clientY-i.top)/o.canvas.height)+1,"drag"!==o.touchMode&&o.raiseEvent("mousemove",{e:o}),o.mouse.previousPosition.x=t.pageX,o.mouse.previousPosition.y=t.pageY});var n="mousewheel";navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(n="DOMMouseScroll"),this.canvas.addEventListener(n,function(e){e.preventDefault();var t="wheelDelta"in e?e.wheelDelta:-40*e.detail;o.raiseEvent("mousewheel",{e:t})}),this.canvas.addEventListener("keydown",function(e){16==e.which?o.keyboard.shift=!0:17==e.which?o.keyboard.ctrl=!0:18==e.which&&(o.keyboard.alt=!0),o.raiseEvent("keydown",{e:e.which})}),this.canvas.addEventListener("keyup",function(e){16==e.which?o.keyboard.shift=!1:17==e.which?o.keyboard.ctrl=!1:18==e.which&&(o.keyboard.alt=!1),o.raiseEvent("keyup",{e:e.which})}),this.canvas.addEventListener("mousedown",function(e){var t=e.button,n="left";0==t?o.mouse.state.left=!0:1==t?(o.mouse.state.middle=!0,n="middle"):2==t&&(o.mouse.state.right=!0,n="right"),o.renderer.setMaxFps(o.highFps),o.raiseEvent("mousedown",{e:o,source:n})}),this.canvas.addEventListener("click",function(e){e.button;o.raiseEvent("click",{e:o,source:"left"})}),this.canvas.addEventListener("dblclick",function(e){e.button;o.raiseEvent("dblclick",{e:o,source:"left"})}),this.canvas.addEventListener("mouseup",function(e){var t=e.button,n="left";0==t?o.mouse.state.left=!1:1==t?(o.mouse.state.middle=!1,n="middle"):2==t&&(o.mouse.state.right=!1,n="right"),o.mouse.previousPosition.x=null,o.mouse.previousPosition.y=null,o.renderer.setMaxFps(o.lowFps),o.raiseEvent("mouseup",{e:o,source:n})}),this.canvas.addEventListener("mouseleave",function(e){o.mouse.state.left=!1,o.mouse.state.middle=!1,o.mouse.state.right=!1,o.mouse.previousPosition.x=null,o.mouse.previousPosition.y=null,o.renderer.setMaxFps(o.lowFps),o.raiseEvent("mouseleave",{e:o,source:o.canvas})})}return _createClass(e,[{key:"addEventListener",value:function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}},{key:"raiseEvent",value:function(e,t){if(this.eventListeners[e])for(var o=0;o<this.eventListeners[e].length;o++)this.eventListeners[e][o](t)}}]),e}(),Lore.OrbitalControls=function(e){function t(e,o,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));i.up=Lore.Vector3f.up(),i.radius=o,i.renderer=e,i.camera=e.camera,i.canvas=e.canvas,i.yRotationLimit=Math.PI,i.dPhi=0,i.dTheta=0,i.dPan=new Lore.Vector3f,i.spherical=new Lore.SphericalCoords,i.lookAt=n||new Lore.Vector3f,i.scale=.95,i.camera.position=new Lore.Vector3f(o,o,o),i.camera.updateProjectionMatrix(),i.camera.updateViewMatrix(),i.rotationLocked=!1;var s=i;return i.addEventListener("mousedrag",function(e){s.update(e.e,e.source)}),i.addEventListener("mousewheel",function(e){s.update({x:0,y:-e.e},"wheel")}),i.update({x:0,y:0},"left"),i}return _inherits(t,e),_createClass(t,[{key:"limitRotationToHorizon",value:function(e){return this.yRotationLimit=e?.5*Math.PI:Math.PI,this}},{key:"setRadius",value:function(e){return this.radius=e,this.camera.position=new Lore.Vector3f(0,0,e),this.camera.updateProjectionMatrix(),this.camera.updateViewMatrix(),this.update(),this}},{key:"setLookAt",value:function(e){return this.camera.position=new Lore.Vector3f(this.radius,this.radius,this.radius),this.lookAt=e.clone(),this.update(),this}},{key:"update",value:function(e,t){if("left"!=t||this.rotationLocked)if("right"==t||"left"==t&&this.rotationLocked){var o=e.x*(this.camera.right-this.camera.left)/this.camera.zoom/this.canvas.clientWidth,n=e.y*(this.camera.top-this.camera.bottom)/this.camera.zoom/this.canvas.clientHeight,i=this.camera.getUpVector().components,s=this.camera.getRightVector().components;this.dPan.components[0]=s[0]*-o+i[0]*n,this.dPan.components[1]=s[1]*-o+i[1]*n,this.dPan.components[2]=s[2]*-o+i[2]*n}else"middle"!=t&&"wheel"!=t||(e.y>0?(this.camera.zoom=Math.max(0,this.camera.zoom*this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom)):e.y<0&&(this.camera.zoom=Math.max(0,this.camera.zoom/this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom)));else this.dTheta=-2*Math.PI*e.x/(.5*this.canvas.clientWidth*this.camera.zoom),this.dPhi=-2*Math.PI*e.y/(.5*this.canvas.clientHeight*this.camera.zoom);var r=this.camera.position.clone().subtract(this.lookAt);return this.spherical.setFromVector(r),this.spherical.components[1]+=this.dPhi,this.spherical.components[2]+=this.dTheta,this.spherical.limit(0,this.yRotationLimit,-(1/0),1/0),this.spherical.secure(),this.lookAt.add(this.dPan),r.setFromSphericalCoords(this.spherical),this.camera.position.copyFrom(this.lookAt).add(r),this.camera.setLookAt(this.lookAt),this.camera.updateViewMatrix(),this.dPhi=0,this.dTheta=0,this.dPan.set(0,0,0),this.raiseEvent("updated"),this}},{key:"setView",value:function(e,t){var o=this.camera.position.clone().subtract(this.lookAt);return this.spherical.setFromVector(o),this.spherical.components[1]=e,this.spherical.components[2]=t,this.spherical.secure(),o.setFromSphericalCoords(this.spherical),this.camera.position.copyFrom(this.lookAt).add(o),this.camera.setLookAt(this.lookAt),this.camera.updateViewMatrix(),this.raiseEvent("updated"),this}},{key:"zoomIn",value:function(){return this.camera.zoom=Math.max(0,this.camera.zoom/this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom),this.raiseEvent("updated"),this}},{key:"zoomOut",value:function(){return this.camera.zoom=Math.max(0,this.camera.zoom*this.scale),this.camera.updateProjectionMatrix(),this.raiseEvent("zoomchanged",this.camera.zoom),this.raiseEvent("updated"),this}},{key:"setTopView",value:function(){return this.setView(0,2*Math.PI),this.rotationLocked=!0,this}},{key:"setBottomView",value:function(){return this.setView(0,0),this.rotationLocked=!0,this}},{key:"setRightView",value:function(){return this.setView(.5*Math.PI,.5*Math.PI),this.rotationLocked=!0,this}},{key:"setLeftView",value:function(){return this.setView(.5*Math.PI,-.5*Math.PI),this.rotationLocked=!0,this}},{key:"setFrontView",value:function(){return this.setView(.5*Math.PI,2*Math.PI),this.rotationLocked=!0,this}},{key:"setBackView",value:function(){return this.setView(.5*Math.PI,Math.PI),this.rotationLocked=!0,this}},{key:"setFreeView",value:function(){return this.setView(.25*Math.PI,.25*Math.PI),this.rotationLocked=!1,this}}]),t}(Lore.ControlsBase),Lore.CameraBase=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.type="Lore.CameraBase",e.renderer=null,e.isProjectionMatrixStale=!1,e.isViewMatrixStale=!1,e.projectionMatrix=new Lore.ProjectionMatrix,e.viewMatrix=new Lore.Matrix4f,e}return _inherits(t,e),_createClass(t,[{key:"init",value:function(e,t){return this.gl=e,this.program=t,this}},{key:"setLookAt",value:function(e){return this.rotation.lookAt(this.position,e,Lore.Vector3f.up()),this}},{key:"updateProjectionMatrix",value:function(){return this}},{key:"updateViewMatrix",value:function(){this.update();var e=this.modelMatrix.clone();return e.invert(),this.viewMatrix=e,this.isViewMatrixStale=!0,this}},{key:"getProjectionMatrix",value:function(){return this.projectionMatrix.entries}},{key:"getViewMatrix",value:function(){return this.viewMatrix.entries}},{key:"sceneToScreen",value:function(e,t){var o=e.clone(),n=t.canvas;return o.project(this),[Math.round((o.components[0]+1)*n.width/2),Math.round((1-o.components[1])*n.height/2)]}}]),t}(Lore.Node),Lore.OrthographicCamera=function(e){function t(e,o,n,i,s,r){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.type="Lore.OrthographicCamera",a.zoom=1,a.left=e,a.right=o,a.top=n,a.bottom=i,a.near=s||.1,a.far=r||2500,a.updateProjectionMatrix(),a}return _inherits(t,e),_createClass(t,[{key:"updateProjectionMatrix",value:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),o=(this.right+this.left)/2,n=(this.top+this.bottom)/2,i=o-e,s=o+e,r=n+t,a=n-t;this.projectionMatrix.setOrthographic(i,s,r,a,this.near,this.far),this.isProjectionMatrixStale=!0}}]),t}(Lore.CameraBase),Lore.Vector3f=function(){function e(t,o,n){_classCallCheck(this,e),1===arguments.length?this.components=new Float32Array(t):(this.components=new Float32Array(3),this.components[0]=t||0,this.components[1]=o||0,this.components[2]=n||0)}return _createClass(e,[{key:"set",value:function(e,t,o){return this.components[0]=e,this.components[1]=t,this.components[2]=o,this}},{key:"getX",value:function(){return this.components[0]}},{key:"getY",value:function(){return this.components[1]}},{key:"getZ",value:function(){return this.components[2]}},{key:"setX",value:function(e){return this.components[0]=e,this}},{key:"setY",value:function(e){return this.components[1]=e,this}},{key:"setZ",value:function(e){return this.components[2]=e,this}},{key:"setFromSphericalCoords",value:function(e){var t=e.components[0],o=e.components[1],n=e.components[2],i=Math.sin(o)*t;return this.components[0]=Math.sin(n)*i,this.components[1]=Math.cos(o)*t,this.components[2]=Math.cos(n)*i,this}},{key:"copyFrom",value:function(e){return this.components[0]=e.components[0],this.components[1]=e.components[1],this.components[2]=e.components[2],this}},{key:"setLength",value:function(e){return this.multiplyScalar(e/this.length())}},{key:"lengthSq",
value:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]}},{key:"length",value:function(){return Math.sqrt(this.lengthSq())}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"multiply",value:function(e){return this.components[0]*=e.components[0],this.components[1]*=e.components[1],this.components[2]*=e.components[2],this}},{key:"multiplyScalar",value:function(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}},{key:"divide",value:function(e){return this.components[0]/=e.components[0],this.components[1]/=e.components[1],this.components[2]/=e.components[2],this}},{key:"divideScalar",value:function(e){return this.components[0]/=e,this.components[1]/=e,this.components[2]/=e,this}},{key:"add",value:function(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this}},{key:"subtract",value:function(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this}},{key:"dot",value:function(e){return this.components[0]*e.components[0]+this.components[1]*e.components[1]+this.components[2]*e.components[2]}},{key:"cross",value:function(e){return new Lore.Vector3f(this.components[1]*e.components[2]-this.components[2]*e.components[1],this.components[2]*e.components[0]-this.components[0]*e.components[2],this.components[0]*e.components[1]-this.components[1]*e.components[0])}},{key:"project",value:function(e){return this.applyProjection(Lore.Matrix4f.multiply(e.projectionMatrix,Lore.Matrix4f.invert(e.modelMatrix)))}},{key:"unproject",value:function(e){return this.applyProjection(Lore.Matrix4f.multiply(e.modelMatrix,Lore.Matrix4f.invert(e.projectionMatrix)))}},{key:"applyProjection",value:function(e){var t=this.components[0],o=this.components[1],n=this.components[2],i=e.entries,s=1/(i[3]*t+i[7]*o+i[11]*n+i[15]);return this.components[0]=(i[0]*t+i[4]*o+i[8]*n+i[12])*s,this.components[1]=(i[1]*t+i[5]*o+i[9]*n+i[13])*s,this.components[2]=(i[2]*t+i[6]*o+i[10]*n+i[14])*s,this}},{key:"toDirection",value:function(e){var t=this.components[0],o=this.components[1],n=this.components[2],i=e.entries;return this.components[0]=i[0]*t+i[4]*o+i[8]*n,this.components[1]=i[1]*t+i[5]*o+i[9]*n,this.components[2]=i[2]*t+i[6]*o+i[10]*n,this.normalize(),this}},{key:"applyQuaternion",value:function(e){var t=this.components[0],o=this.components[1],n=this.components[2],i=e.components[0],s=e.components[1],r=e.components[2],a=e.components[3],c=a*t+s*n-r*o,u=a*o+r*t-i*n,l=a*n+i*o-s*t,h=-i*t-s*o-r*n;return this.components[0]=c*a+h*-i+u*-r-l*-s,this.components[1]=u*a+h*-s+l*-i-c*-r,this.components[2]=l*a+h*-r+c*-s-u*-i,this}},{key:"distanceToSq",value:function(e){var t=this.components[0]-e.components[0],o=this.components[1]-e.components[1],n=this.components[2]-e.components[2];return t*t+o*o+n*n}},{key:"distanceTo",value:function(e){return Math.sqrt(this.distanceToSq(e))}},{key:"clone",value:function(){return new Lore.Vector3f(this.components[0],this.components[1],this.components[2])}},{key:"equals",value:function(e){return this.components[0]===e.components[0]&&this.components[1]===e.components[1]&&this.components[2]===e.components[2]}},{key:"toString",value:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}}],[{key:"normalize",value:function(e){return Lore.Vector3f.divideScalar(e,e.length())}},{key:"multiply",value:function(e,t){return new Lore.Vector3f(e.components[0]*t.components[0],e.components[1]*t.components[1],e.components[2]*t.components[2])}},{key:"multiplyScalar",value:function(e,t){return new Lore.Vector3f(e.components[0]*t,e.components[1]*t,e.components[2]*t)}},{key:"divide",value:function(e,t){return new Lore.Vector3f(e.components[0]/t.components[0],e.components[1]/t.components[1],e.components[2]/t.components[2])}},{key:"divideScalar",value:function(e,t){return new Lore.Vector3f(e.components[0]/t,e.components[1]/t,e.components[2]/t)}},{key:"add",value:function(e,t){return new Lore.Vector3f(e.components[0]+t.components[0],e.components[1]+t.components[1],e.components[2]+t.components[2])}},{key:"subtract",value:function(e,t){return new Lore.Vector3f(e.components[0]-t.components[0],e.components[1]-t.components[1],e.components[2]-t.components[2])}},{key:"cross",value:function(e,t){return new Lore.Vector3f(e.components[1]*t.components[2]-e.components[2]*t.components[1],e.components[2]*t.components[0]-e.components[0]*t.components[2],e.components[0]*t.components[1]-e.components[1]*t.components[0])}},{key:"dot",value:function(e,t){return e.components[0]*t.components[0]+e.components[1]*t.components[1]+e.components[2]*t.components[2]}},{key:"forward",value:function(){return new Lore.Vector3f(0,0,1)}},{key:"up",value:function(){return new Lore.Vector3f(0,1,0)}},{key:"right",value:function(){return new Lore.Vector3f(1,0,0)}}]),e}(),Lore.Matrix3f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Float32Array([1,0,0,0,1,0,0,0,1]);_classCallCheck(this,e),this.entries=t}return _createClass(e,[{key:"clone",value:function(){return new Lore.Matrix3f(new Float32Array(this.entries))}},{key:"equals",value:function(e){for(var t=0;t<this.entries.length;t++)if(this.entries[t]!==e.entries[t])return!1;return!0}}]),e}(),Lore.Matrix4f=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);_classCallCheck(this,e),this.entries=t}return _createClass(e,[{key:"set",value:function(e,t,o,n,i,s,r,a,c,u,l,h,f,m,p,d){this.entries.set([e,t,o,n,i,s,r,a,c,u,l,h,f,m,p,d])}},{key:"multiplyA",value:function(e){var t=this.entries[0],o=this.entries[4],n=this.entries[8],i=this.entries[12],s=this.entries[1],r=this.entries[5],a=this.entries[9],c=this.entries[13],u=this.entries[2],l=this.entries[6],h=this.entries[10],f=this.entries[14],m=this.entries[3],p=this.entries[7],d=this.entries[11],v=this.entries[15],y=e.entries[0],g=e.entries[4],x=e.entries[8],b=e.entries[12],L=e.entries[1],P=e.entries[5],A=e.entries[9],_=e.entries[13],k=e.entries[2],N=e.entries[6],w=e.entries[10],S=e.entries[14],M=e.entries[3],E=e.entries[7],C=e.entries[11],F=e.entries[15];return this.entries[0]=t*y+o*L+n*k+i*M,this.entries[1]=s*y+r*L+a*k+c*M,this.entries[2]=m*y+p*L+d*k+v*M,this.entries[3]=t*g+o*P+n*N+i*E,this.entries[4]=u*y+l*L+h*k+f*M,this.entries[5]=s*g+r*P+a*N+c*E,this.entries[6]=u*g+l*P+h*N+f*E,this.entries[7]=m*g+p*P+d*N+v*E,this.entries[8]=t*x+o*A+n*w+i*C,this.entries[9]=s*x+r*A+a*w+c*C,this.entries[10]=u*x+l*A+h*w+f*C,this.entries[11]=m*x+p*A+d*w+v*C,this.entries[12]=t*b+o*_+n*S+i*F,this.entries[13]=s*b+r*_+a*S+c*F,this.entries[14]=u*b+l*_+h*S+f*F,this.entries[15]=m*b+p*_+d*S+v*F,this}},{key:"multiplyB",value:function(e){var t=e.entries[0],o=e.entries[4],n=e.entries[8],i=e.entries[12],s=e.entries[1],r=e.entries[5],a=e.entries[9],c=e.entries[13],u=e.entries[2],l=e.entries[6],h=e.entries[10],f=e.entries[14],m=e.entries[3],p=e.entries[7],d=e.entries[11],v=e.entries[15],y=this.entries[0],g=this.entries[4],x=this.entries[8],b=this.entries[12],L=this.entries[1],P=this.entries[5],A=this.entries[9],_=this.entries[13],k=this.entries[2],N=this.entries[6],w=this.entries[10],S=this.entries[14],M=this.entries[3],E=this.entries[7],C=this.entries[11],F=this.entries[15];return this.entries[0]=t*y+o*L+n*k+i*M,this.entries[1]=s*y+r*L+a*k+c*M,this.entries[2]=m*y+p*L+d*k+v*M,this.entries[3]=t*g+o*P+n*N+i*E,this.entries[4]=u*y+l*L+h*k+f*M,this.entries[5]=s*g+r*P+a*N+c*E,this.entries[6]=u*g+l*P+h*N+f*E,this.entries[7]=m*g+p*P+d*N+v*E,this.entries[8]=t*x+o*A+n*w+i*C,this.entries[9]=s*x+r*A+a*w+c*C,this.entries[10]=u*x+l*A+h*w+f*C,this.entries[11]=m*x+p*A+d*w+v*C,this.entries[12]=t*b+o*_+n*S+i*F,this.entries[13]=s*b+r*_+a*S+c*F,this.entries[14]=u*b+l*_+h*S+f*F,this.entries[15]=m*b+p*_+d*S+v*F,this}},{key:"scale",value:function(e){var t=e.components[0],o=e.components[1],n=e.components[2];return this.entries[0]*=t,this.entries[1]*=t,this.entries[2]*=t,this.entries[3]*=t,this.entries[4]*=o,this.entries[5]*=o,this.entries[6]*=o,this.entries[7]*=o,this.entries[8]*=n,this.entries[9]*=n,this.entries[10]*=n,this.entries[11]*=n,this}},{key:"setPosition",value:function(e){return this.entries[12]=e.components[0],this.entries[13]=e.components[1],this.entries[14]=e.components[2],this}},{key:"setRotation",value:function(e){var t=e.components[0],o=e.components[1],n=e.components[2],i=e.components[3],s=t+t,r=o+o,a=n+n,c=t*s,u=t*r,l=t*a,h=o*r,f=o*a,m=n*a,p=i*s,d=i*r,v=i*a;return this.entries[0]=1-(h+m),this.entries[1]=u+v,this.entries[2]=l-d,this.entries[4]=u-v,this.entries[5]=1-(c+m),this.entries[6]=f+p,this.entries[8]=l+d,this.entries[9]=f-p,this.entries[10]=1-(c+h),this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[12]=0,this.entries[13]=0,this.entries[14]=0,this.entries[15]=1,this}},{key:"determinant",value:function(){var e=a.entries[0],t=a.entries[4],o=a.entries[8],n=a.entries[12],i=a.entries[1],s=a.entries[5],r=a.entries[9],c=a.entries[13],u=a.entries[2],l=a.entries[6],h=a.entries[10],f=a.entries[14];return a.entries[3]*(n*r*l-o*c*l-n*s*h+t*c*h+o*s*f-t*r*f)+a.entries[7]*(e*r*f-e*c*h+n*i*h-o*i*f+o*c*u-n*r*u)+a.entries[11]*(e*c*l-e*s*f-n*i*l+t*i*f+n*s*u-t*c*u)+a.entries[15]*(-o*s*u-e*r*l+e*s*h+o*i*l-t*i*h+t*r*u)}},{key:"decompose",value:function(e,t,o){var n=(new Lore.Vector3f,new Lore.Matrix4f);position.set(this.entries[12],this.entries[13],this.entries[14]);var i=Math.sqrt(this.entries[0]*this.entries[0]+this.entries[1]*this.entries[1]+this.entries[2]*this.entries[2]),s=Math.sqrt(this.entries[4]*this.entries[4]+this.entries[5]*this.entries[5]+this.entries[6]*this.entries[6]),r=Math.sqrt(this.entries[8]*this.entries[8]+this.entries[9]*this.entries[9]+this.entries[10]*this.entries[10]);this.determinant()<0&&(i=-i),o.set(i,s,r);var a=1/i,c=1/s,u=1/r;return n.entries.set(this.entries),n.entries[0]*=a,n.entries[1]*=a,n.entries[2]*=a,n.entries[4]*=c,n.entries[5]*=c,n.entries[6]*=c,n.entries[8]*=u,n.entries[9]*=u,n.entries[10]*=u,t.setFromMatrix(n),this}},{key:"compose",value:function(e,t,o){return this.setRotation(t),this.scale(o),this.setPosition(e),this}},{key:"invert",value:function(){var e=new Lore.Matrix4f,t=this.entries;e.entries[0]=t[5]*t[10]*t[15]-t[5]*t[11]*t[14]-t[9]*t[6]*t[15]+t[9]*t[7]*t[14]+t[13]*t[6]*t[11]-t[13]*t[7]*t[10],e.entries[4]=-t[4]*t[10]*t[15]+t[4]*t[11]*t[14]+t[8]*t[6]*t[15]-t[8]*t[7]*t[14]-t[12]*t[6]*t[11]+t[12]*t[7]*t[10],e.entries[8]=t[4]*t[9]*t[15]-t[4]*t[11]*t[13]-t[8]*t[5]*t[15]+t[8]*t[7]*t[13]+t[12]*t[5]*t[11]-t[12]*t[7]*t[9],e.entries[12]=-t[4]*t[9]*t[14]+t[4]*t[10]*t[13]+t[8]*t[5]*t[14]-t[8]*t[6]*t[13]-t[12]*t[5]*t[10]+t[12]*t[6]*t[9],e.entries[1]=-t[1]*t[10]*t[15]+t[1]*t[11]*t[14]+t[9]*t[2]*t[15]-t[9]*t[3]*t[14]-t[13]*t[2]*t[11]+t[13]*t[3]*t[10],e.entries[5]=t[0]*t[10]*t[15]-t[0]*t[11]*t[14]-t[8]*t[2]*t[15]+t[8]*t[3]*t[14]+t[12]*t[2]*t[11]-t[12]*t[3]*t[10],e.entries[9]=-t[0]*t[9]*t[15]+t[0]*t[11]*t[13]+t[8]*t[1]*t[15]-t[8]*t[3]*t[13]-t[12]*t[1]*t[11]+t[12]*t[3]*t[9],e.entries[13]=t[0]*t[9]*t[14]-t[0]*t[10]*t[13]-t[8]*t[1]*t[14]+t[8]*t[2]*t[13]+t[12]*t[1]*t[10]-t[12]*t[2]*t[9],e.entries[2]=t[1]*t[6]*t[15]-t[1]*t[7]*t[14]-t[5]*t[2]*t[15]+t[5]*t[3]*t[14]+t[13]*t[2]*t[7]-t[13]*t[3]*t[6],e.entries[6]=-t[0]*t[6]*t[15]+t[0]*t[7]*t[14]+t[4]*t[2]*t[15]-t[4]*t[3]*t[14]-t[12]*t[2]*t[7]+t[12]*t[3]*t[6],e.entries[10]=t[0]*t[5]*t[15]-t[0]*t[7]*t[13]-t[4]*t[1]*t[15]+t[4]*t[3]*t[13]+t[12]*t[1]*t[7]-t[12]*t[3]*t[5],e.entries[14]=-t[0]*t[5]*t[14]+t[0]*t[6]*t[13]+t[4]*t[1]*t[14]-t[4]*t[2]*t[13]-t[12]*t[1]*t[6]+t[12]*t[2]*t[5],e.entries[3]=-t[1]*t[6]*t[11]+t[1]*t[7]*t[10]+t[5]*t[2]*t[11]-t[5]*t[3]*t[10]-t[9]*t[2]*t[7]+t[9]*t[3]*t[6],e.entries[7]=t[0]*t[6]*t[11]-t[0]*t[7]*t[10]-t[4]*t[2]*t[11]+t[4]*t[3]*t[10]+t[8]*t[2]*t[7]-t[8]*t[3]*t[6],e.entries[11]=-t[0]*t[5]*t[11]+t[0]*t[7]*t[9]+t[4]*t[1]*t[11]-t[4]*t[3]*t[9]-t[8]*t[1]*t[7]+t[8]*t[3]*t[5],e.entries[15]=t[0]*t[5]*t[10]-t[0]*t[6]*t[9]-t[4]*t[1]*t[10]+t[4]*t[2]*t[9]+t[8]*t[1]*t[6]-t[8]*t[2]*t[5];var o=t[0]*e.entries[0]+t[1]*e.entries[4]+t[2]*e.entries[8]+t[3]*e.entries[12];if(0==o)throw"Determinant is zero.";o=1/o;for(var n=0;n<16;n++)this.entries[n]=e.entries[n]*o;return this}},{key:"clone",value:function(){return new Lore.Matrix4f(new Float32Array(this.entries))}},{key:"equals",value:function(e){for(var t=0;t<this.entries.length;t++)if(this.entries[t]!==e.entries[t])return!1;return!0}},{key:"toString",value:function(){console.log(this.entries[0]+", "+this.entries[4]+", "+this.entries[8]+", "+this.entries[12]),console.log(this.entries[1]+", "+this.entries[5]+", "+this.entries[9]+", "+this.entries[13]),console.log(this.entries[2]+", "+this.entries[6]+", "+this.entries[10]+", "+this.entries[14]),console.log(this.entries[3]+", "+this.entries[7]+", "+this.entries[11]+", "+this.entries[15])}}],[{key:"multiply",value:function(e,t){var o=e.entries[0],n=e.entries[4],i=e.entries[8],s=e.entries[12],r=e.entries[1],a=e.entries[5],c=e.entries[9],u=e.entries[13],l=e.entries[2],h=e.entries[6],f=e.entries[10],m=e.entries[14],p=e.entries[3],d=e.entries[7],v=e.entries[11],y=e.entries[15],g=t.entries[0],x=t.entries[4],b=t.entries[8],L=t.entries[12],P=t.entries[1],A=t.entries[5],_=t.entries[9],k=t.entries[13],N=t.entries[2],w=t.entries[6],S=t.entries[10],M=t.entries[14],E=t.entries[3],C=t.entries[7],F=t.entries[11],T=t.entries[15];return new Lore.Matrix4f(new Float32Array([o*g+n*P+i*N+s*E,r*g+a*P+c*N+u*E,l*g+h*P+f*N+m*E,p*g+d*P+v*N+y*E,o*x+n*A+i*w+s*C,r*x+a*A+c*w+u*C,l*x+h*A+f*w+m*C,p*x+d*A+v*w+y*C,o*b+n*_+i*S+s*F,r*b+a*_+c*S+u*F,l*b+h*_+f*S+m*F,p*b+d*_+v*S+y*F,o*L+n*k+i*M+s*T,r*L+a*k+c*M+u*T,l*L+h*k+f*M+m*T,p*L+d*k+v*M+y*T]))}},{key:"fromQuaternion",value:function(e){var t=e.components[0],o=e.components[1],n=e.components[2],i=e.components[3],s=t+t,r=o+o,a=n+n,c=t*s,u=t*r,l=t*a,h=o*r,f=o*a,m=n*a,p=i*s,d=i*r,v=i*a;return new Lore.Matrix4f(new Float32Array([1-(h+m),u+v,l-d,0,u-v,1-(c+m),f+p,0,l+d,f-p,1-(c+h),0,0,0,0,1]))}},{key:"lookAt",value:function(e,t,o){var n=Lore.Vector3f.subtract(e,t).normalize();0===n.lengthSq()&&(n.components[2]=1);var i=Lore.Vector3f.cross(o,n).normalize();0===i.lengthSq()&&(n.components[2]+=1e-4,i=Lore.Vector3f.cross(o,n).normalize());var s=Lore.Vector3f.cross(n,i);return new Lore.Matrix4f(new Float32Array([i.components[0],i.components[1],i.components[2],0,s.components[0],s.components[1],s.components[2],0,n.components[0],n.components[1],n.components[2],0,0,0,0,1]))}},{key:"compose",value:function(e,t,o){var n=new Lore.Matrix4f;return n.setRotation(t),n.scale(o),n.setPosition(e),n}},{key:"invert",value:function(e){var t=new Lore.Matrix4f,o=e.entries;t.entries[0]=o[5]*o[10]*o[15]-o[5]*o[11]*o[14]-o[9]*o[6]*o[15]+o[9]*o[7]*o[14]+o[13]*o[6]*o[11]-o[13]*o[7]*o[10],t.entries[4]=-o[4]*o[10]*o[15]+o[4]*o[11]*o[14]+o[8]*o[6]*o[15]-o[8]*o[7]*o[14]-o[12]*o[6]*o[11]+o[12]*o[7]*o[10],t.entries[8]=o[4]*o[9]*o[15]-o[4]*o[11]*o[13]-o[8]*o[5]*o[15]+o[8]*o[7]*o[13]+o[12]*o[5]*o[11]-o[12]*o[7]*o[9],t.entries[12]=-o[4]*o[9]*o[14]+o[4]*o[10]*o[13]+o[8]*o[5]*o[14]-o[8]*o[6]*o[13]-o[12]*o[5]*o[10]+o[12]*o[6]*o[9],t.entries[1]=-o[1]*o[10]*o[15]+o[1]*o[11]*o[14]+o[9]*o[2]*o[15]-o[9]*o[3]*o[14]-o[13]*o[2]*o[11]+o[13]*o[3]*o[10],t.entries[5]=o[0]*o[10]*o[15]-o[0]*o[11]*o[14]-o[8]*o[2]*o[15]+o[8]*o[3]*o[14]+o[12]*o[2]*o[11]-o[12]*o[3]*o[10],t.entries[9]=-o[0]*o[9]*o[15]+o[0]*o[11]*o[13]+o[8]*o[1]*o[15]-o[8]*o[3]*o[13]-o[12]*o[1]*o[11]+o[12]*o[3]*o[9],t.entries[13]=o[0]*o[9]*o[14]-o[0]*o[10]*o[13]-o[8]*o[1]*o[14]+o[8]*o[2]*o[13]+o[12]*o[1]*o[10]-o[12]*o[2]*o[9],t.entries[2]=o[1]*o[6]*o[15]-o[1]*o[7]*o[14]-o[5]*o[2]*o[15]+o[5]*o[3]*o[14]+o[13]*o[2]*o[7]-o[13]*o[3]*o[6],t.entries[6]=-o[0]*o[6]*o[15]+o[0]*o[7]*o[14]+o[4]*o[2]*o[15]-o[4]*o[3]*o[14]-o[12]*o[2]*o[7]+o[12]*o[3]*o[6],t.entries[10]=o[0]*o[5]*o[15]-o[0]*o[7]*o[13]-o[4]*o[1]*o[15]+o[4]*o[3]*o[13]+o[12]*o[1]*o[7]-o[12]*o[3]*o[5],t.entries[14]=-o[0]*o[5]*o[14]+o[0]*o[6]*o[13]+o[4]*o[1]*o[14]-o[4]*o[2]*o[13]-o[12]*o[1]*o[6]+o[12]*o[2]*o[5],t.entries[3]=-o[1]*o[6]*o[11]+o[1]*o[7]*o[10]+o[5]*o[2]*o[11]-o[5]*o[3]*o[10]-o[9]*o[2]*o[7]+o[9]*o[3]*o[6],t.entries[7]=o[0]*o[6]*o[11]-o[0]*o[7]*o[10]-o[4]*o[2]*o[11]+o[4]*o[3]*o[10]+o[8]*o[2]*o[7]-o[8]*o[3]*o[6],t.entries[11]=-o[0]*o[5]*o[11]+o[0]*o[7]*o[9]+o[4]*o[1]*o[11]-o[4]*o[3]*o[9]-o[8]*o[1]*o[7]+o[8]*o[3]*o[5],t.entries[15]=o[0]*o[5]*o[10]-o[0]*o[6]*o[9]-o[4]*o[1]*o[10]+o[4]*o[2]*o[9]+o[8]*o[1]*o[6]-o[8]*o[2]*o[5];var n=o[0]*t.entries[0]+o[1]*t.entries[4]+o[2]*t.entries[8]+o[3]*t.entries[12];if(0==n)throw"Determinant is zero.";n=1/n;for(var i=0;i<16;i++)t.entries[i]=t.entries[i]*n;return t}}]),e}(),Lore.Quaternion=function(){function e(t,o,n,i){_classCallCheck(this,e),1===arguments.length?this.components=new Float32Array(t):2===arguments.length?(this.components=new Float32Array(4),this.setFromAxisAngle(t,o)):(this.components=new Float32Array(4),this.components[0]=t||0,this.components[1]=o||0,this.components[2]=n||0,this.components[3]=void 0!==i?i:1)}return _createClass(e,[{key:"getX",value:function(){return this.components[0]}},{key:"getY",value:function(){return this.components[1]}},{key:"getZ",value:function(){return this.components[2]}},{key:"getW",value:function(){return this.components[3]}},{key:"set",value:function(e,t,o,n){this.components[0]=e,this.components[1]=t,this.components[2]=o,this.components[3]=n}},{key:"setX",value:function(e){this.components[0]=e}},{key:"setY",value:function(e){this.components[1]=e}},{key:"setZ",value:function(e){this.components[2]=e}},{key:"setW",value:function(e){this.components[3]=e}},{key:"setFromAxisAngle",value:function(e,t){var o=Lore.Vector3f.normalize(e),n=t/2,i=Math.sin(n);this.components[0]=o.components[0]*i,this.components[1]=o.components[1]*i,this.components[2]=o.components[2]*i,this.components[3]=Math.cos(n)}},{key:"setFromUnitVectors",value:function(e,t){var o=null,n=e.dot(t)+1;n<1e-6?(o=new Lore.Vector3f,n=0,Math.abs(e.components[0])>Math.abs(e.components[2])?o.set(-e.components[1],e.components[0],0):o.set(0,-e.components[2],e.components[1])):o=Lore.Vector3f.cross(e,t),this.set(o.components[0],o.components[1],o.components[2],n),this.normalize()}},{key:"lookAt",value:function(e,t,o){return this.setFromMatrix(Lore.Matrix4f.lookAt(e,t,o)),this}},{key:"lengthSq",value:function(){return this.components[0]*this.components[0]+this.components[1]*this.components[1]+this.components[2]*this.components[2]+this.components[3]*this.components[3]}},{key:"length",value:function(){return Math.sqrt(this.lengthSq())}},{key:"inverse",value:function(){return this.conjugate().normalize()}},{key:"normalize",value:function(){var e=this.length();if(0===e)this.components[0]=0,this.components[1]=0,this.components[2]=0,this.components[3]=1;else{var t=1/e;this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this.components[3]*=t}return this}},{key:"dot",value:function(e){return this.components[0]*e.components[0]+this.components[1]*e.components[1]+this.components[2]*e.components[2]+this.components[3]*e.components[3]}},{key:"multiplyA",value:function(e){var t=this.components[0]*e.components[3]+this.components[3]*e.components[0]+this.components[1]*e.components[2]-this.components[2]*e.components[1],o=this.components[1]*e.components[3]+this.components[3]*e.components[1]+this.components[2]*e.components[0]-this.components[0]*e.components[2],n=this.components[2]*e.components[3]+this.components[3]*e.components[2]+this.components[0]*e.components[1]-this.components[1]*e.components[0],i=this.components[3]*e.components[3]-this.components[0]*e.components[0]-this.components[1]*e.components[1]-this.components[2]*e.components[2];return this.components[0]=t,this.components[1]=o,this.components[2]=n,this.components[3]=i,this}},{key:"multiplyB",value:function(e){var t=e.components[0]*this.components[3]+e.components[3]*this.components[0]+e.components[1]*this.components[2]-e.components[2]*this.components[1],o=e.components[1]*this.components[3]+e.components[3]*this.components[1]+e.components[2]*this.components[0]-e.components[0]*this.components[2],n=e.components[2]*this.components[3]+e.components[3]*this.components[2]+e.components[0]*this.components[1]-e.components[1]*this.components[0],i=e.components[3]*this.components[3]-e.components[0]*this.components[0]-e.components[1]*this.components[1]-e.components[2]*this.components[2];return this.components[0]=t,this.components[1]=o,this.components[2]=n,this.components[3]=i,this}},{key:"multiplyScalar",value:function(e){return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e,this}},{key:"conjugate",value:function(){return this.components[0]*=-1,this.components[1]*=-1,this.components[2]*=-1,this}},{key:"add",value:function(e){return this.components[0]+=e.components[0],this.components[1]+=e.components[1],this.components[2]+=e.components[2],this.components[3]+=e.components[3],this}},{key:"subtract",value:function(e){return this.components[0]-=e.components[0],this.components[1]-=e.components[1],this.components[2]-=e.components[2],this.components[3]-=e.components[3],this}},{key:"rotateX",value:function(e){var t=e/2;return this.multiplyA(new Lore.Quaternion(Math.sin(t),0,0,Math.cos(t)))}},{key:"rotateY",value:function(e){var t=e/2;return this.multiplyA(new Lore.Quaternion(0,Math.sin(t),0,Math.cos(t)))}},{key:"rotateZ",value:function(e){var t=e/2;return this.multiplyA(new Lore.Quaternion(0,0,Math.sin(t),Math.cos(t)))}},{key:"toAxisAngle",value:function(){console.warn("The method toAxisAngle() has not been implemented.")}},{key:"toRotationMatrix",value:function(){var e=this.components[0],t=this.components[1],o=this.components[2],n=this.components[3],i=e*e,s=e*t,r=e*o,a=e*n,c=t*n,u=t*t,l=t*o,h=o*o,f=o*n,m=new Lore.Matrix4f;return m.entries[0]=1-2*(u+h),m.entries[1]=2*(s+f),m.entries[2]=2*(r-c),m.entries[4]=2*(l-f),m.entries[5]=1-2*(i+h),m.entries[6]=2*(l+a),m.entries[8]=2*(r+c),m.entries[9]=2*(l-a),m.entries[10]=1-2*(i+u),m}},{key:"setFromMatrix",value:function(e){var t=e.entries[0],o=e.entries[4],n=e.entries[8],i=e.entries[1],s=e.entries[5],r=e.entries[9],a=e.entries[2],c=e.entries[6],u=e.entries[10],l=t+s+u;if(l>0){var h=.5/Math.sqrt(l+1);this.components[0]=(c-r)*h,this.components[1]=(n-a)*h,this.components[2]=(i-o)*h,this.components[3]=.25/h}else if(t>s&&t>u){var f=2*Math.sqrt(1+t-s-u);this.components[0]=.25*f,this.components[1]=(o+i)/f,this.components[2]=(n+a)/f,this.components[3]=(c-r)/f}else if(s>u){var m=2*Math.sqrt(1+s-t-u);this.components[0]=(o+i)/m,this.components[1]=.25*m,this.components[2]=(r+c)/m,this.components[3]=(n-a)/m}else{var p=2*Math.sqrt(1+u-t-s);this.components[0]=(n+a)/p,this.components[1]=(r+c)/p,this.components[2]=.25*p,this.components[3]=(i-o)/p}return this}},{key:"clone",value:function(){return new Lore.Quaternion(this.components[0],this.components[1],this.components[2],this.components[3])}},{key:"equals",value:function(e){return this.components[0]===e.components[0]&&this.components[1]===e.components[1]&&this.components[2]===e.components[2]&&this.components[3]===e.components[3]}},{key:"toString",value:function(){return"x: "+this.getX()+", y: "+this.getY()+", z: "+this.getZ()+", w: "+this.getW()}}]),e}(),Lore.Quaternion.dot=function(e,t){return new Lore.Quaternion(e.components[0]*t.components[0]+e.components[1]*t.components[1]+e.components[2]*t.components[2]+e.components[3]*t.components[3])},Lore.Quaternion.multiply=function(e,t){return new Lore.Quaternion(e.components[0]*t.components[3]+e.components[3]*t.components[0]+e.components[1]*t.components[2]-e.components[2]*t.components[1],e.components[1]*t.components[3]+e.components[3]*t.components[1]+e.components[2]*t.components[0]-e.components[0]*t.components[2],e.components[2]*t.components[3]+e.components[3]*t.components[2]+e.components[0]*t.components[1]-e.components[1]*t.components[0],e.components[3]*t.components[3]+e.components[0]*t.components[0]+e.components[1]*t.components[1]-e.components[2]*t.components[2])},Lore.Quaternion.multiplyScalar=function(e,t){return new Lore.Quaternion(e.components[0]*t,e.components[1]*t,e.components[2]*t,e.components[3]*t)},Lore.Quaternion.inverse=function(e){return new Lore.Quaternion(e.components).conjugate().normalize()},Lore.Quaternion.normalize=function(e){var t=e.length();if(0===t)return new Lore.Quaternion(0,0,0,1);var o=1/t;return new Lore.Quaternion(e.components[0]*o,e.components[1]*o,e.components[2]*o,e.components[3]*o)},Lore.Quaternion.conjugate=function(e){return new Lore.Quaternion(e.components[0]*-1,e.components[1]*-1,e.components[2]*-1,e.components[3])},Lore.Quaternion.add=function(e,t){return new Lore.Quaternion(e.components[0]+t.components[0],e.components[1]+t.components[1],e.components[2]+t.components[2],e.components[3]+t.components[3])},Lore.Quaternion.subtract=function(e,t){return new Lore.Quaternion(e.components[0]-t.components[0],e.components[1]-t.components[1],e.components[2]-t.components[2],e.components[3]-t.components[3])},Lore.Quaternion.fromMatrix=function(e){var t=new Lore.Quaternion;return t.setFromMatrix(e),t},Lore.Quaternion.slerp=function(e,t,o){if(0===o)return new Lore.Quaternion(e.components);if(1===o)return new Lore.Quaternion(t.components);var n=new Lore.Quaternion(t.components),i=e.components[0]*n.components[0]+e.components[1]*n.components[1]+e.components[2]*n.components[2]+e.components[3]*n.components[3];if(i<0&&(n.multiplyScalar(-1),i=-i),Math.abs(i)>=1)return new Lore.Quaternion(e.components);var s=Math.acos(i),r=sqrt(1-i*i);if(Math.abs(r)<.001)return new Lore.Quaternion(.5*e.components[0]+.5*n.components[0],.5*e.components[1]+.5*n.components[1],.5*e.components[2]+.5*n.components[2],.5*e.components[3]+.5*n.components[3]);var a=Math.sin((1-o)*s)/r,c=Math.sin(o*s)/r;return new Lore.Quaternion(e.components[0]*a+n.components[0]*c,e.components[1]*a+n.components[1]*c,e.components[2]*a+n.components[2]*c,e.components[3]*a+n.components[3]*c)},Lore.SphericalCoords=function(){function e(t,o,n){_classCallCheck(this,e),this.components=new Float32Array(3),this.radius=void 0!==t?t:1,this.phi=o?o:0,this.theta=n?n:0}return _createClass(e,[{key:"set",value:function(e,t,o){return this.components[0]=e,this.components[1]=t,this.components[2]=o,this}},{key:"secure",value:function(){return this.components[1]=Math.max(1e-6,Math.min(Math.PI-1e-6,this.components[1])),this}},{key:"setFromVector",value:function(e){return this.components[0]=e.length(),0===this.components[0]?(this.components[1]=0,this.components[2]=0):(this.components[1]=Math.acos(Math.max(-1,Math.min(1,e.components[1]/this.components[0]))),this.components[2]=Math.atan2(e.components[0],e.components[2])),this}},{key:"limit",value:function(e,t,o,n){this.components[1]=Math.max(e,Math.min(t,this.components[1])),this.components[2]=Math.max(o,Math.min(n,this.components[2]))}},{key:"clone",value:function(){return new Lore.SphericalCoords(this.radius,this.phi,this.theta)}},{key:"toString",value:function(){return"("+this.components[0]+", "+this.components[1]+", "+this.components[2]+")"}}]),e}(),Lore.ProjectionMatrix=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,e),_createClass(t,[{key:"setOrthographic",value:function(e,t,o,n,i,s){var r=1/(t-e),a=1/(o-n),c=1/(s-i),u=(t+e)*r,l=(o+n)*a,h=(s+i)*c;return this.set(),this.entries[0]=2*r,this.entries[4]=0,this.entries[8]=0,this.entries[12]=-u,this.entries[1]=0,this.entries[5]=2*a,this.entries[9]=0,this.entries[13]=-l,this.entries[2]=0,this.entries[6]=0,this.entries[10]=-2*c,this.entries[14]=-h,this.entries[3]=0,this.entries[7]=0,this.entries[11]=0,this.entries[15]=1,this}}]),t}(Lore.Matrix4f),Lore.Statistics=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"randomNormal",value:function(){var e=void 0,t=void 0,o=void 0,n=void 0,i=void 0;if(null!==Lore.Statistics.spareRandomNormal)e=Lore.Statistics.spareRandomNormal,Lore.Statistics.spareRandomNormal=null;else{do{t=2*Math.random()-1,o=2*Math.random()-1,n=t*t+o*o}while(0===n||n>=1);i=Math.sqrt(-2*Math.log(n)/n),e=t*i,Lore.Statistics.spareRandomNormal=o*i}return e/14}},{key:"randomNormalInRange",value:function(e,t){var o=void 0;do{o=Lore.Statistics.randomNormal()}while(o<e||o>t);return o}},{key:"randomNormalScaled",value:function(e,t){return Lore.Statistics.randomNormalInRange(-1,1)*t+e}},{key:"normalize",value:function(e){for(var t=Number.MIN_VALUE,o=Number.MAX_VALUE,n=0;n<e.length;n++){var i=e[n];i>t&&(t=i),i<o&&(o=i)}for(var s=t-o,r=0;r<e.length;r++)e[r]=(e[r]-o)/s;return[o,t]}},{key:"scale",value:function(e,t,o,n,i){return(i-n)*(e-t)/(o-t)+n}}]),e}(),Lore.Statistics.spareRandomNormal=null,Lore.Ray=function(){function e(t,o){_classCallCheck(this,e),this.source=t||new Lore.Vector3f,this.direction=o||new Lore.Vector3f}return _createClass(e,[{key:"copyFrom",value:function(e){return this.source.copyFrom(e.source),this.direction.copyFrom(e.direction),this}},{key:"applyProjection",value:function(e){return this.direction.add(this.source).applyProjection(e),this.source.applyProjection(e),this.direction.subtract(this.source),this.direction.normalize(),this}},{key:"distanceSqToPoint",value:function(e){var t=Lore.Vector3f.subtract(e,this.source),o=t.dot(this.direction);return o<0?this.source.distanceToSq(e):(t.copyFrom(this.direction).multiplyScalar(o).add(this.source),t.distanceToSq(e))}},{key:"closestPointToPoint",value:function(e){var t=Lore.Vector3f.subtract(e,this.source),o=t.dot(this.direction);return o<0?t.copyFrom(this.source):t.copyFrom(this.direction).multiplyScalar(o).add(this.source)}}]),e}();var RadixSort=function(){function e(){_classCallCheck(this,e),this.max=void 0,this.mask=void 0,this.histograms=void 0,this.indices=void 0,this.tmpIndices=void 0}return _createClass(e,[{key:"sort",value:function(e,t){var o=null;t?(o=new e.constructor(e.length),o.set(e)):o=e,this.max=2048,this.mask=this.max-1,this.histograms=new Int32Array(this.max*Math.ceil(64/11));var n=new Int32Array(o.buffer,o.byteOffset,o.byteLength>>2),i=Math.ceil(8*o.BYTES_PER_ELEMENT/11),s=this.max*(i-1),r=1<<(8*o.BYTES_PER_ELEMENT-1)%11,a=(r<<1)-1,c=null,u=new n.constructor(n.length);this.indices=new Uint32Array(n.length),this.tmpIndices=new Uint32Array(n.length);for(var l=(new Uint32Array(n.length),this.max*i),h=0;h<l;h++)this.histograms[h]=0;this.initHistograms(n,s,a);for(var f=0;f<=s;f+=this.max)for(var m=0,p=f;p<f+this.max;p++){var d=this.histograms[p]+m;this.histograms[p]=m-1,m=d}return this.lsbPass(n,u),c=u,u=n,n=c,this.pass(n,u),c=u,u=n,n=c,this.msbPass(n,u,r),{array:new Float32Array(u.buffer,u.byteOffset,o.length),indices:this.indices}}},{key:"lsbPass",value:function(e,t){for(var o=0,n=e.length;o<n;o++){var i=e[o];i^=2147483648|i>>31;var s=++this.histograms[i&this.mask];this.indices[s]=o,t[s]=i}}},{key:"pass",value:function(e,t){for(var o=e.length,n=0;n<o;n++){var i=e[n],s=++this.histograms[this.max+(i>>>11&this.mask)];this.tmpIndices[s]=this.indices[n],t[s]=i}this.indices.set(this.tmpIndices)}},{key:"msbPass",value:function(e,t,o){for(var n=(o<<1)-1,i=e.length,s=2*this.max,r=0;r<i;r++){var a=e[r],c=a>>31,u=++this.histograms[s+(a>>>22&n)];this.tmpIndices[u]=this.indices[r],t[u]=a^(2147483648|~c)}this.indices.set(this.tmpIndices)}},{key:"initHistograms",value:function(e,t,o){for(var n=e.length,i=0;i<n;i++){var s=e[i];s^=2147483648|s>>31;for(var r=0,a=0;r<t;r+=this.max,a+=11)this.histograms[r+(s>>>a&this.mask)]++;this.histograms[r+(s>>>a&o)]++}}}]),e}();Lore.HelperBase=function(e){function t(e,o,n){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.renderer=e,i.shader=Lore.Shaders[n],i.geometry=i.renderer.createGeometry(o,n),i}return _inherits(t,e),_createClass(t,[{key:"setAttribute",value:function(e,t){this.geometry.addAttribute(e,t)}},{key:"getAttribute",value:function(e){return this.geometry.attributes[e].data}},{key:"updateAttribute",value:function(e,t,o){
for(var n=this.geometry.attributes[e],i=t*n.attributeLength,s=0;s<n.attributeLength;s++)n.data[i+s]=o[s]||n.data[i+s];n.stale=!0}},{key:"updateAttributeAll",value:function(e,t){for(var o=this.geometry.attributes[e],n=0;n<o.data.length;n++)o.data[n]=t[n];o.stale=!0}},{key:"draw",value:function(){this.geometry.draw(this.renderer)}}]),t}(Lore.Node),Lore.PointHelper=function(e){function t(e,o,n,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,n)),r={octree:!0,octreeThreshold:500,octreeMaxDepth:8,pointScale:1,maxPointSize:100};return s.opts=Lore.Utils.extend(!0,r,i),s.indices=null,s.octree=null,s.geometry.setMode(Lore.DrawModes.points),s.initPointSize(),s.filters={},s.pointSize=1*s.opts.pointScale,s}return _inherits(t,e),_createClass(t,[{key:"getMaxLength",value:function(e,t,o){return Math.max(e.length,Math.max(t.length,o.length))}},{key:"setPositions",value:function(e){return this.setAttribute("position",e),this}},{key:"setPositionsXYZ",value:function(e,t,o,n){for(var i=new Float32Array(3*n),s=0;s<n;s++){var r=3*s;i[r]=e[s]||0,i[r+1]=t[s]||0,i[r+2]=o[s]||0}if(this.opts.octree){for(var a=Lore.AABB.fromPoints(i),c=new Uint32Array(n),u=0;u<n;u++)c[u]=u;this.octree=new Lore.Octree(this.opts.octreeThreshold,this.opts.octreeMaxDepth),this.octree.build(c,i,a)}return this.setAttribute("position",i),this}},{key:"setPositionsXYZHSS",value:function(e,t,o,n,i,s){var r=this.getMaxLength(e,t,o);return this.setPositionsXYZ(e,t,o,r),this.setHSS(n,i,s,r),this.renderer.camera.updateProjectionMatrix(),this.renderer.camera.updateViewMatrix(),this}},{key:"setRGB",value:function(e,t,o){for(var n=new Float32Array(3*e.length),i=this.getAttribute("color"),s=0;s<e.length;s++){var r=3*s;n[r]=e[s],n[r+1]=t[s],n[r+2]=o[s]}for(var a=0;a<n.length;a+=3){var c=n[a],u=n[a+1],l=n[a+2];n[a]=Lore.Color.rgbToHsl(c,u,l)[0],n[a+1]=i[1],n[a+2]=i[2]}return this.updateColors(n),this}},{key:"setColors",value:function(e){return this.setAttribute("color",e),this}},{key:"updateColors",value:function(e){return this.updateAttributeAll("color",e),this}},{key:"updateColor",value:function(e,t){return this.updateAttribute("color",e,t.components),this}},{key:"setPointSize",value:function(e){var t=e*this.opts.pointScale;return t>this.opts.maxPointSize?this.pointSize=this.opts.maxPointSize:this.pointSize=t,this.geometry.shader.uniforms.size.value=this.pointSize,t>this.opts.maxPointSize?this.opts.maxPointSize/t*.5:.5}},{key:"getPointSize",value:function(){return this.geometry.shader.uniforms.size.value}},{key:"getPointScale",value:function(){return this.opts.pointScale}},{key:"setFogDistance",value:function(e){return this.geometry.shader.uniforms.fogDistance.value=e,this}},{key:"initPointSize",value:function(){return this.setPointSize(this.renderer.camera.zoom+.1),this}},{key:"getCutoff",value:function(){return this.geometry.shader.uniforms.cutoff.value}},{key:"setCutoff",value:function(e){return this.geometry.shader.uniforms.cutoff.value=e,this}},{key:"getHue",value:function(e){return this.getAttribute("color")[3*e]}},{key:"getPosition",value:function(e){var t=this.getAttribute("position");return new Lore.Vector3f(t[3*e],t[3*e+1],t[3*e+2])}},{key:"setHSS",value:function(e,t,o,n){for(var i=new Float32Array(3*n),s=0;s<3*n;s+=3)i[s]=e,i[s+1]=t,i[s+2]=o;this.setColors(i)}},{key:"addFilter",value:function(e,t){return t.setGeometry(this.geometry),this.filters[e]=t,this}},{key:"removeFilter",value:function(e){return delete this.filters[e],this}},{key:"getFilter",value:function(e){return this.filters[e]}}]),t}(Lore.HelperBase),Lore.TreeHelper=function(e){function t(e,o,n,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,n));return s.defaults={pointScale:1,maxPointSize:100},s.opts=Lore.Utils.extend(!0,s.defaults,i),s.indices=null,s.geometry.setMode(Lore.DrawModes.lines),s.initPointSize(),s.filters={},s}return _inherits(t,e),_createClass(t,[{key:"getMaxLength",value:function(e,t,o){return Math.max(e.length,Math.max(t.length,o.length))}},{key:"setPositions",value:function(e){this.setAttribute("position",e)}},{key:"setPositionsXYZ",value:function(e,t,o,n){for(var i=new Float32Array(3*n),s=0;s<n;s++){var r=3*s;i[r]=e[s]||0,i[r+1]=t[s]||0,i[r+2]=o[s]||0}this.setAttribute("position",i)}},{key:"setPositionsXYZHSS",value:function(e,t,o,n,i,s){var r=this.getMaxLength(e,t,o);this.setPositionsXYZ(e,t,o,r),this.setHSS(n,i,s,r)}},{key:"setColors",value:function(e){this.setAttribute("color",e)}},{key:"updateColors",value:function(e){this.updateAttributeAll("color",e)}},{key:"updateColor",value:function(e,t){this.updateAttribute("color",e,t.components)}},{key:"setPointSize",value:function(e){e*this.opts.pointScale>this.opts.maxPointSize||(this.geometry.shader.uniforms.size.value=e*this.opts.pointScale)}},{key:"getPointSize",value:function(){return this.geometry.shader.uniforms.size.value}},{key:"setFogDistance",value:function(e){this.geometry.shader.uniforms.fogDistance.value=e}},{key:"initPointSize",value:function(){this.geometry.shader.uniforms.size.value=this.renderer.camera.zoom*this.opts.pointScale}},{key:"getCutoff",value:function(){return this.geometry.shader.uniforms.cutoff.value}},{key:"setCutoff",value:function(e){this.geometry.shader.uniforms.cutoff.value=e}},{key:"getHue",value:function(e){return this.getAttribute("color")[3*e]}},{key:"setHSS",value:function(e,t,o,n){for(var i=new Float32Array(3*n),s=0;s<3*n;s+=3)i[s]=e,i[s+1]=t,i[s+2]=o;this.setColors(i)}},{key:"addFilter",value:function(e,t){t.setGeometry(this.geometry),this.filters[e]=t}},{key:"removeFilter",value:function(e){delete this.filters[e]}},{key:"getFilter",value:function(e){return this.filters[e]}}]),t}(Lore.HelperBase),Lore.CoordinatesHelper=function(e){function t(e,o,n,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,n));return s.defaults={position:new Lore.Vector3f,axis:{x:{length:50,color:Lore.Color.fromHex("#222222")},y:{length:50,color:Lore.Color.fromHex("#222222")},z:{length:50,color:Lore.Color.fromHex("#222222")}},ticks:{enabled:!0,x:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")},y:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")},z:{count:10,length:5,offset:new Lore.Vector3f,color:Lore.Color.fromHex("#222222")}},box:{enabled:!0,x:{color:Lore.Color.fromHex("#999999")},y:{color:Lore.Color.fromHex("#999999")},z:{color:Lore.Color.fromHex("#999999")}}},s.opts=Lore.Utils.extend(!0,s.defaults,i),s.geometry.setMode(Lore.DrawModes.lines),s.init(),s}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){var e=this.opts.position.components,t=this.opts.axis,o=[e[0],e[1],e[2],e[0]+t.x.length,e[1],e[2],e[0],e[1],e[2],e[0],e[1]+t.y.length,e[2],e[0],e[1],e[2],e[0],e[1],e[2]+t.z.length],n=t.x.color.components,i=t.y.color.components,s=t.z.color.components,r=[n[0],n[1],n[2],n[0],n[1],n[2],i[0],i[1],i[2],i[0],i[1],i[2],s[0],s[1],s[2],s[0],s[1],s[2]];if(this.opts.box.enabled){var a=this.opts.box.x.color.components,c=this.opts.box.y.color.components,u=this.opts.box.z.color.components;o.push(e[0]+t.x.length,e[1]+t.y.length,e[2]+t.z.length,e[0],e[1]+t.y.length,e[2]+t.z.length,e[0]+t.x.length,e[1],e[2]+t.z.length,e[0],e[1],e[2]+t.z.length,e[0]+t.x.length,e[1]+t.y.length,e[2],e[0],e[1]+t.y.length,e[2],e[0]+t.x.length,e[1]+t.y.length,e[2]+t.z.length,e[0]+t.x.length,e[1],e[2]+t.z.length,e[0],e[1]+t.y.length,e[2]+t.z.length,e[0],e[1],e[2]+t.z.length,e[0]+t.x.length,e[1]+t.y.length,e[2],e[0]+t.x.length,e[1],e[2],e[0]+t.x.length,e[1]+t.y.length,e[2]+t.z.length,e[0]+t.x.length,e[1]+t.y.length,e[2],e[0],e[1]+t.y.length,e[2]+t.z.length,e[0],e[1]+t.y.length,e[2],e[0]+t.x.length,e[1],e[2]+t.z.length,e[0]+t.x.length,e[1],e[2]),r.push(a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],a[0],a[1],a[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],c[0],c[1],c[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2],u[0],u[1],u[2])}if(this.opts.ticks.enabled){for(var l=this.opts.ticks.x,h=t.x.length/l.count,f=this.opts.ticks.y,m=t.y.length/f.count,p=this.opts.ticks.z,d=t.z.length/p.count,v=e[0],y=l.color.components,g=0;g<l.count-1;g++)v+=h,o.push(v+l.offset.components[0],e[1]+l.offset.components[1],e[2]+l.offset.components[2],v+l.offset.components[0],e[1]+l.offset.components[1]+l.length,e[2]+l.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[0];for(var x=0;x<l.count-1;x++)v+=h,o.push(v+l.offset.components[0],e[1]+l.offset.components[1],e[2]+l.offset.components[2],v+l.offset.components[0],e[1]+l.offset.components[1],e[2]+l.offset.components[2]+l.length),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[1],y=f.color.components;for(var b=0;b<f.count-1;b++)v+=m,o.push(e[0]+l.offset.components[0],v+l.offset.components[1],e[2]+l.offset.components[2],e[0]+l.offset.components[0]+l.length,v+l.offset.components[1],e[2]+l.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[1];for(var L=0;L<f.count-1;L++)v+=m,o.push(e[0]+l.offset.components[0],v+l.offset.components[1],e[2]+l.offset.components[2],e[0]+l.offset.components[0],v+l.offset.components[1],e[2]+l.offset.components[2]+l.length),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[2],y=p.color.components;for(var P=0;P<p.count-1;P++)v+=d,o.push(e[0]+l.offset.components[0],e[1]+l.offset.components[1],v+l.offset.components[2],e[0]+l.offset.components[0],e[1]+l.offset.components[1]+l.length,v+l.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2]);v=e[2];for(var A=0;A<p.count-1;A++)v+=d,o.push(e[0]+l.offset.components[0],e[1]+l.offset.components[1],v+l.offset.components[2],e[0]+l.offset.components[0]+l.length,e[1]+l.offset.components[1],v+l.offset.components[2]),r.push(y[0],y[1],y[2],y[0],y[1],y[2])}this.setAttribute("position",new Float32Array(o)),this.setAttribute("color",new Float32Array(r))}}]),t}(Lore.HelperBase),Lore.OctreeHelper=function(e){function t(e,o,n,i,s){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o,n));r.defaults={visualize:!1},r.opts=Lore.Utils.extend(!0,r.defaults,s),r.eventListeners={},r.target=i,r.renderer=e,r.octree=r.target.octree,r.raycaster=new Lore.Raycaster,r.hovered=null,r.selected=[];var a=r;return e.controls.addEventListener("dblclick",function(e){if(!e.e.mouse.state.middle&&!e.e.mouse.state.right){var t=e.e.mouse.normalizedPosition,o=a.getIntersections(t);if(o.length>0){if(a.selectedContains(o[0].index))return;a.addSelected(o[0])}}}),e.controls.addEventListener("mousemove",function(t){if(!(t.e.mouse.state.left||t.e.mouse.state.middle||t.e.mouse.state.right)){var o=t.e.mouse.normalizedPosition,n=a.getIntersections(o);if(n.length>0){if(a.hovered&&a.hovered.index===n[0].index)return;a.hovered=n[0],a.hovered.screenPosition=a.renderer.camera.sceneToScreen(n[0].position,e),a.raiseEvent("hoveredchanged",{e:a.hovered})}else a.hovered=null,a.raiseEvent("hoveredchanged",{e:null})}}),e.controls.addEventListener("zoomchanged",function(e){a.setPointSizeFromZoom(e)}),e.controls.addEventListener("updated",function(){for(var t=0;t<a.selected.length;t++)a.selected[t].screenPosition=a.renderer.camera.sceneToScreen(a.selected[t].position,e);a.hovered&&(a.hovered.screenPosition=a.renderer.camera.sceneToScreen(a.hovered.position,e)),a.raiseEvent("updated")}),r.init(),r}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){"centers"===this.opts.visualize?this.drawCenters():"cubes"===this.opts.visualize?this.drawBoxes():this.geometry.isVisible=!1,this.setPointSizeFromZoom(1)}},{key:"setPointSizeFromZoom",value:function(e){var t=this.target.setPointSize(e+.1);this.setThreshold(t)}},{key:"getScreenPosition",value:function(e){var t=this.target.geometry.attributes.position.data,o=3*e,n=new Lore.Vector3f(t[o],t[o+1],t[o+2]);return this.renderer.camera.sceneToScreen(n,this.renderer)}},{key:"addSelected",value:function(e){if(!isNaN(parseFloat(e))){var t=this.target.geometry.attributes.position.data,o=this.target.geometry.attributes.color.data,n=3*e;e={distance:-1,index:e,locCode:-1,position:new Lore.Vector3f(t[n],t[n+1],t[n+2]),color:o?[o[n],o[n+1],o[n+2]]:null}}var i=this.selected.length;this.selected.push(e),this.selected[i].screenPosition=this.renderer.camera.sceneToScreen(e.position,this.renderer),this.raiseEvent("selectedchanged",{e:this.selected})}},{key:"removeSelected",value:function(e){this.selected.splice(e,1),this.raiseEvent("selectedchanged",{e:this.selected})}},{key:"clearSelected",value:function(){this.selected=[],this.raiseEvent("selectedchanged",{e:this.selected})}},{key:"selectedContains",value:function(e){for(var t=0;t<this.selected.length;t++)if(this.selected[t].index===e)return!0;return!1}},{key:"setHovered",value:function(e){if(!that.hovered||that.hovered.index!==result[0].index){var t=3*e,o=this.target.geometry.attributes.position.data,n=null;"color"in this.target.geometry.attributes&&(n=this.target.geometry.attributes.color.data),that.hovered={index:e,position:new Lore.Vector3f(o[t],o[t+1],o[t+2]),color:n?[n[t],n[t+1],n[t+2]]:null},that.hovered.screenPosition=that.renderer.camera.sceneToScreen(that.hovered.position,renderer),that.raiseEvent("hoveredchanged",{e:that.hovered})}}},{key:"selectHovered",value:function(){this.hovered&&!this.selectedContains(this.hovered.index)&&this.addSelected({distance:this.hovered.distance,index:this.hovered.index,locCode:this.hovered.locCode,position:this.hovered.position,color:this.hovered.color})}},{key:"showCenters",value:function(){this.opts.visualize="centers",this.drawCenters(),this.geometry.isVisible=!0}},{key:"showCubes",value:function(){this.opts.visualize="cubes",this.drawBoxes(),this.geometry.isVisible=!0}},{key:"hide",value:function(){this.opts.visualize=!1,this.geometry.isVisible=!1,this.setAttribute("position",new Float32Array([])),this.setAttribute("color",new Float32Array([]))}},{key:"getIntersections",value:function(e){this.raycaster.set(this.renderer.camera,e.x,e.y);var t=this.octree.raySearch(this.raycaster),o=this.rayIntersections(t);return o.sort(function(e,t){return e.distance-t.distance}),o}},{key:"addEventListener",value:function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}},{key:"raiseEvent",value:function(e,t){if(this.eventListeners[e])for(var o=0;o<this.eventListeners[e].length;o++)this.eventListeners[e][o](t)}},{key:"drawCenters",value:function(){this.geometry.setMode(Lore.DrawModes.points);var e=this.octree.aabbs,t=Object.keys(e).length,o=new Float32Array(3*t),n=new Float32Array(3*t),i=0;for(key in e){var s=e[key].center.components,r=3*i;o[r]=1,o[r+1]=1,o[r+2]=1,n[r]=s[0],n[r+1]=s[1],n[r+2]=s[2],i++}this.setAttribute("position",new Float32Array(n)),this.setAttribute("color",new Float32Array(o))}},{key:"drawBoxes",value:function(){this.geometry.setMode(Lore.DrawModes.lines);for(var e=this.octree.aabbs,t=Object.keys(e).length,o=new Float32Array(24*t*3),n=new Float32Array(24*t*3),i=0;i<o.length;i++)o[i]=1;var s=0;for(key in e){var r=Lore.AABB.getCorners(e[key]);n[s++]=r[0][0],n[s++]=r[0][1],n[s++]=r[0][2],n[s++]=r[1][0],n[s++]=r[1][1],n[s++]=r[1][2],n[s++]=r[0][0],n[s++]=r[0][1],n[s++]=r[0][2],n[s++]=r[2][0],n[s++]=r[2][1],n[s++]=r[2][2],n[s++]=r[0][0],n[s++]=r[0][1],n[s++]=r[0][2],n[s++]=r[4][0],n[s++]=r[4][1],n[s++]=r[4][2],n[s++]=r[1][0],n[s++]=r[1][1],n[s++]=r[1][2],n[s++]=r[3][0],n[s++]=r[3][1],n[s++]=r[3][2],n[s++]=r[1][0],n[s++]=r[1][1],n[s++]=r[1][2],n[s++]=r[5][0],n[s++]=r[5][1],n[s++]=r[5][2],n[s++]=r[2][0],n[s++]=r[2][1],n[s++]=r[2][2],n[s++]=r[3][0],n[s++]=r[3][1],n[s++]=r[3][2],n[s++]=r[2][0],n[s++]=r[2][1],n[s++]=r[2][2],n[s++]=r[6][0],n[s++]=r[6][1],n[s++]=r[6][2],n[s++]=r[3][0],n[s++]=r[3][1],n[s++]=r[3][2],n[s++]=r[7][0],n[s++]=r[7][1],n[s++]=r[7][2],n[s++]=r[4][0],n[s++]=r[4][1],n[s++]=r[4][2],n[s++]=r[5][0],n[s++]=r[5][1],n[s++]=r[5][2],n[s++]=r[4][0],n[s++]=r[4][1],n[s++]=r[4][2],n[s++]=r[6][0],n[s++]=r[6][1],n[s++]=r[6][2],n[s++]=r[5][0],n[s++]=r[5][1],n[s++]=r[5][2],n[s++]=r[7][0],n[s++]=r[7][1],n[s++]=r[7][2],n[s++]=r[6][0],n[s++]=r[6][1],n[s++]=r[6][2],n[s++]=r[7][0],n[s++]=r[7][1],n[s++]=r[7][2]}this.setAttribute("position",n),this.setAttribute("color",o)}},{key:"setThreshold",value:function(e){this.raycaster.threshold=e}},{key:"rayIntersections",value:function(e){var t=[],o=Lore.Matrix4f.invert(this.target.modelMatrix),n=new Lore.Ray,i=this.raycaster.threshold*this.target.getPointScale(),s=this.target.geometry.attributes.position.data,r=null;"color"in this.target.geometry.attributes&&(r=this.target.geometry.attributes.color.data);var a=this.target.getCutoff();n.copyFrom(this.raycaster.ray).applyProjection(o);for(var c=i,u=c*c,l=0;l<e.length;l++){var h=e[l].index,f=e[l].locCode,m=3*h,p=new Lore.Vector3f(s[m],s[m+1],s[m+2]);if(n.distanceSqToPoint(p)<u){var d=n.closestPointToPoint(p);d.applyProjection(this.target.modelMatrix);var v=this.raycaster.ray.source.distanceTo(d),y=Lore.FilterBase.isVisible(this.target.geometry,h);if(v<this.raycaster.near||v>this.raycaster.far||v<a||!y)continue;t.push({distance:v,index:h,locCode:f,position:p,color:r?[r[m],r[m+1],r[m+2]]:null})}}return t}}]),t}(Lore.HelperBase),Lore.FilterBase=function(){function e(t,o){_classCallCheck(this,e),this.type="Lore.FilterBase",this.geometry=null,this.attribute=t,this.attributeIndex=o,this.active=!1}return _createClass(e,[{key:"getGeometry",value:function(){return this.geometry}},{key:"setGeometry",value:function(e){this.geometry=e}},{key:"filter",value:function(){}}],[{key:"isVisible",value:function(e,t){return e.attributes.color.data[3*t+2]>0}}]),e}(),Lore.InRangeFilter=function(e){function t(e,o,n,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,o));return s.min=n,s.max=i,s}return _inherits(t,e),_createClass(t,[{key:"getMin",value:function(){return this.min}},{key:"setMin",value:function(e){this.min=e}},{key:"getMax",value:function(){return this.max}},{key:"setMax",value:function(e){this.max=e}},{key:"filter",value:function(){for(var e=this.geometry.attributes[this.attribute],t=0;t<e.data.length;t+=e.attributeLength){var o=e.data[t+this.attributeIndex],n=this.geometry.attributes.color.data[t+2];o>this.max||o<this.min?this.geometry.attributes.color.data[t+2]=-Math.abs(n):this.geometry.attributes.color.data[t+2]=Math.abs(n)}this.geometry.updateAttribute("color")}},{key:"reset",value:function(){for(var e=this.geometry.attributes[this.attribute],t=0;t<e.data.length;t+=e.attributeLength){var o=this.geometry.attributes.color.data[t+2];this.geometry.attributes.color.data[t+2]=Math.abs(o)}this.geometry.updateAttribute("color")}}]),t}(Lore.FilterBase),Lore.FileReaderBase=function(){function e(t){_classCallCheck(this,e),this.elementId=t,this.element=document.getElementById(this.elementId),this.eventListeners={};var o=this;this.element.addEventListener("change",function(){var e=new FileReader;e.onload=function(){o.loaded(e.result)},e.readAsBinaryString(this.files[0])})}return _createClass(e,[{key:"addEventListener",value:function(e,t){this.eventListeners[e]||(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}},{key:"raiseEvent",value:function(e,t){if(this.eventListeners[e])for(var o=0;o<this.eventListeners[e].length;o++)this.eventListeners[e][o](t)}},{key:"loaded",value:function(e){}}]),e}(),Lore.CsvFileReader=function(e){function t(e,o){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.defaults={separator:",",cols:[],types:[],header:!0},n.opts=Lore.Utils.extend(!0,Lore.CsvFileReader.defaults,o),n.columns=[],n}return _inherits(t,e),_createClass(t,[{key:"loaded",value:function(e){e=e.replace("\n\n","\n"),e=e.replace(/^\s+|\s+$/g,"");for(var t=e.split("\n"),o=t.length,n=!0,i=this.opts.cols,s=this.opts.header?1:0,r=s;r<o;r++){var a=t[r].split(this.opts.separator);if(0==i.length)for(var c=0;c<a.length;c++)i.push[c];if(n){for(var u=0;u<i.length;u++)this.createArray(u,this.opts.types[u],o-s);n=!1}for(var l=0;l<i.length;l++)this.columns[l][r-s]=a[i[l]]}return this.raiseEvent("loaded",this.columns),this}},{key:"createArray",value:function(e,t,o){return this.columns[e]="Int8Array"==t?new Int8Array(o):"Uint8Array"==t?new Uint8Array(o):"Uint8ClampedArray"==t?new Uint8ClampedArray(o):"Int16Array"==t?new Int16Array(o):"Uint16Array"==t?new Uint16Array(o):"Int32Array"==t?new Int32Array(o):"Uint32Array"==t?new Uint32Array(o):"Float32Array"==t?new Float32Array(o):"Float64Array"==t?new Float64Array(o):new Array(o),this}}]),t}(Lore.FileReaderBase),Lore.Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"extend",value:function(){var e={},t=!1,o=0,n=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(t=arguments[0],o++);for(;o<n;o++){var i=arguments[o];!function(o){for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t&&"[object Object]"===Object.prototype.toString.call(o[n])?e[n]=Lore.Utils.extend(!0,e[n],o[n]):e[n]=o[n])}(i)}return e}},{key:"arrayContains",value:function(e,t){for(var o=0;o<e.length;o++)if(e[o]===t)return!0;return!1}},{key:"concatTypedArrays",value:function(e,t){var o=new e.constructor(e.length+t.length);return o.set(e),o.set(t,e.length),o}},{key:"msb",value:function(e){return 2147483648&e?31:Lore.Utils.msb(e<<1|1)-1}},{key:"mergePointDistances",value:function(e,t){var o={};return o.indices=Lore.Utils.concatTypedArrays(e.indices,t.indices),o.distancesSq=Lore.Utils.concatTypedArrays(e.distancesSq,t.distancesSq),o}}]),e}(),Lore.Shaders.default=new Lore.Shader("Default",{size:new Lore.Uniform("size",5,"float"),type:new Lore.Uniform("type",0,"float"),fogDistance:new Lore.Uniform("fogDistance",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogDistance;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","float rand(vec2 co) {","return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 1.0);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0) {","vDiscard = 1.0;","return;","}","float fog_start = cutoff;","float fog_end = fogDistance + cutoff;","float dist = abs(mv_pos.z - fog_start);","gl_PointSize = size;","if(fogDistance > 0.0) {","hsv.b = clamp((fog_end - dist) / (fog_end - fog_start), 0.0, 1.0);","}","hsv.g = 0.5 + 0.4 * rand(position.xy);","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard > 0.5) discard;","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.defaultAnimated=new Lore.Shader("DefaultAnimated",{size:new Lore.Uniform("size",5,"float"),fogDistance:new Lore.Uniform("fogDistance",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float"),time:new Lore.Uniform("time",0,"float")},["uniform float size;","uniform float fogDistance;","uniform float cutoff;","uniform float time;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 1.0);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0) {","vDiscard = 1.0;","return;","}","float fog_start = cutoff;","float fog_end = fogDistance + cutoff;","float dist = abs(mv_pos.z - fog_start);","gl_PointSize = size;","if(fogDistance > 0.0) {","hsv.b = clamp((fog_end - dist) / (fog_end - fog_start), 0.0, 1.0);","}","hsv.g *= max(0.15, abs(sin(time * 0.002)));","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard > 0.5) discard;","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.coordinates=new Lore.Shader("Coordinates",{},["attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","gl_PointSize = 1.0;","vColor = color;","}"],["varying vec3 vColor;","void main() {","gl_FragColor = vec4(vColor, 1.0);","}"]),Lore.Shaders.tree=new Lore.Shader("Tree",{size:new Lore.Uniform("size",5,"float"),fogDistance:new Lore.Uniform("fogDistance",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogDistance;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 0.75);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0) {","vDiscard = 1.0;","return;","}","float fog_start = cutoff;","float fog_end = fogDistance + cutoff;","float dist = abs(mv_pos.z - fog_start);","gl_PointSize = size;","if(fogDistance > 0.0) {","hsv.b = clamp((fog_end - dist) / (fog_end - fog_start), 0.0, 1.0);","}","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","void main() {","if(vDiscard > 0.5) discard;","gl_FragColor = vec4(vColor, 0.5);","}"]),Lore.Shaders.sphere=new Lore.Shader("Sphere",{size:new Lore.Uniform("size",5,"float"),fogDistance:new Lore.Uniform("fogDistance",0,"float"),cutoff:new Lore.Uniform("cutoff",0,"float")},["uniform float size;","uniform float fogDistance;","uniform float cutoff;","attribute vec3 position;","attribute vec3 color;","varying vec3 vColor;","varying float vDiscard;","vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c) {","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}","void main() {","vec3 hsv = vec3(color.r, color.g, 1.0);","float saturation = color.g;","float point_size = color.b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vec4 mv_pos = modelViewMatrix * vec4(position, 1.0);","vDiscard = 0.0;","if(-mv_pos.z < cutoff || point_size <= 0.0) {","vDiscard = 1.0;","return;","}","float fog_start = cutoff;","float fog_end = fogDistance + cutoff;","float dist = abs(mv_pos.z - fog_start);","gl_PointSize = size;","if(fogDistance > 0.0) {","hsv.b = clamp((fog_end - dist) / (fog_end - fog_start), 0.0, 1.0);","}","vColor = hsv2rgb(hsv);","}"],["varying vec3 vColor;","varying float vDiscard;","float rand(vec2 co) {","return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","}","void main() {","if(vDiscard > 0.5) discard;","vec3 N;","N.xy = gl_PointCoord * 2.0 - vec2(1.0);","float mag = dot(N.xy, N.xy);","if (mag > 1.0) discard;   // discard fragments outside circle","N.z = sqrt(1.0 - mag);","vec3 light_dir = vec3(0.25, -0.25, 1.0);","float diffuse = max(0.25, dot(light_dir, N));","vec3 v = normalize(vec3(0.1, -0.2, 1.0));","vec3 h = normalize(light_dir + v);","float specular = pow(max(0.0, dot(N, h)), 100.0);","// specular += 0.1 * rand(gl_PointCoord);","gl_FragColor = vec4(vColor * diffuse + specular * 0.5, 1.0);","}"]),Lore.Shaders.defaultEffect=new Lore.Shader("DefaultEffect",{},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["uniform sampler2D fbo_texture;","varying vec2 f_texcoord;","void main(void) {","vec4 color = texture2D(fbo_texture, f_texcoord);","gl_FragColor = color;","}"]),Lore.Shaders.fxaaEffect=new Lore.Shader("FXAAEffect",{resolution:new Lore.Uniform("resolution",[500,500],"float_vec2")
},["attribute vec2 v_coord;","uniform sampler2D fbo_texture;","uniform vec2 resolution;","varying vec2 f_texcoord;","void main() {","gl_Position = vec4(v_coord, 0.0, 1.0);","f_texcoord = (v_coord + 1.0) / 2.0;","}"],["#define fxaaTexture2D(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#define fxaaSat(x) clamp(x, 0.0, 1.0)","#define FXAA_QUALITY_PS 8","#define FXAA_QUALITY_P0 1.0","#define FXAA_QUALITY_P1 1.5","#define FXAA_QUALITY_P2 2.0","#define FXAA_QUALITY_P3 2.0","#define FXAA_QUALITY_P4 2.0","#define FXAA_QUALITY_P5 2.0","#define FXAA_QUALITY_P6 4.0","#define FXAA_QUALITY_P7 12.0","vec4 fxaa(vec2 pos, sampler2D tex, vec2 resolution,","float subpixQuality, float edgeThreshold, float edgeThresholdMin) {","vec2 posM;","posM.x = pos.x;","posM.y = pos.y;","vec4 rgbyM = texture2D(tex, posM);","vec3 luma = vec3(0.299, 0.587, 0.114);","float lumaM = dot(rgbyM.xyz, luma);","float lumaS = dot(fxaaTexture2D(tex, posM, vec2(0, 1), resolution.xy).xyz, luma);","float lumaE = dot(fxaaTexture2D(tex, posM, vec2(1, 0), resolution.xy).xyz, luma);","float lumaN = dot(fxaaTexture2D(tex, posM, vec2(0, -1), resolution.xy).xyz, luma);","float lumaW = dot(fxaaTexture2D(tex, posM, vec2(-1, 0), resolution.xy).xyz, luma);","float maxSM = max(lumaS, lumaM);","float minSM = min(lumaS, lumaM);","float maxESM = max(lumaE, maxSM);","float minESM = min(lumaE, minSM);","float maxWN = max(lumaN, lumaW);","float minWN = min(lumaN, lumaW);","float rangeMax = max(maxWN, maxESM);","float rangeMin = min(minWN, minESM);","float rangeMaxScaled = rangeMax * edgeThreshold;","float range = rangeMax - rangeMin;","float rangeMaxClamped = max(edgeThresholdMin, rangeMaxScaled);","bool earlyExit = range < rangeMaxClamped;","// maybe return rgbyM -> leave unchanged","if(earlyExit) return rgbyM;","float lumaNW = dot(fxaaTexture2D(tex, posM, vec2(-1, -1), resolution.xy).xyz, luma);","float lumaSE = dot(fxaaTexture2D(tex, posM, vec2(1, 1), resolution.xy).xyz, luma);","float lumaNE = dot(fxaaTexture2D(tex, posM, vec2(1, -1), resolution.xy).xyz, luma);","float lumaSW = dot(fxaaTexture2D(tex, posM, vec2(-1, 1), resolution.xy).xyz, luma);","float lumaNS = lumaN + lumaS;","float lumaWE = lumaW + lumaE;","float subpixRcpRange = 1.0 / range;","float subpixNSWE = lumaNS + lumaWE;","float edgeHorz1 = (-2.0 * lumaM) + lumaNS;","float edgeVert1 = (-2.0 * lumaM) + lumaWE;","float lumaNESE = lumaNE + lumaSE;","float lumaNWNE = lumaNW + lumaNE;","float edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","float edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","float lumaNWSW = lumaNW + lumaSW;","float lumaSWSE = lumaSW + lumaSE;","float edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","float edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","float edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","float edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","float edgeHorz = abs(edgeHorz3) + edgeHorz4;","float edgeVert = abs(edgeVert3) + edgeVert4;","float subpixNWSWNESE = lumaNWSW + lumaNESE;","float lengthSign = resolution.x;","bool horzSpan = edgeHorz >= edgeVert;","float subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","if(!horzSpan) lumaN = lumaW;","if(!horzSpan) lumaS = lumaE;","if(horzSpan) lengthSign = resolution.y;","float subpixB = (subpixA * (1.0/12.0)) - lumaM;","float gradientN = lumaN - lumaM;","float gradientS = lumaS - lumaM;","float lumaNN = lumaN + lumaM;","float lumaSS = lumaS + lumaM;","bool pairN = abs(gradientN) >= abs(gradientS);","float gradient = max(abs(gradientN), abs(gradientS));","if(pairN) lengthSign = -lengthSign;","float subpixC = fxaaSat(abs(subpixB) * subpixRcpRange);","vec2 posB;","posB.x = posM.x;","posB.y = posM.y;","vec2 offNP;","offNP.x = (!horzSpan) ? 0.0 : resolution.x;","offNP.y = ( horzSpan) ? 0.0 : resolution.y;","if(!horzSpan) posB.x += lengthSign * 0.5;","if( horzSpan) posB.y += lengthSign * 0.5;","vec2 posN;","posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","vec2 posP;","posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","float subpixD = ((-2.0)*subpixC) + 3.0;","float lumaEndN = texture2D(tex, posN).w;","float subpixE = subpixC * subpixC;","float lumaEndP = texture2D(tex, posP).w;","if(!pairN) lumaNN = lumaSS;","float gradientScaled = gradient * 1.0/4.0;","float lumaMM = lumaM - lumaNN * 0.5;","float subpixF = subpixD * subpixE;","bool lumaMLTZero = lumaMM < 0.0;","lumaEndN -= lumaNN * 0.5;","lumaEndP -= lumaNN * 0.5;","bool doneN = abs(lumaEndN) >= gradientScaled;","bool doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","bool doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","#if (FXAA_QUALITY_PS > 3)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","#if (FXAA_QUALITY_PS > 4)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","#if (FXAA_QUALITY_PS > 5)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","#if (FXAA_QUALITY_PS > 6)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","#if (FXAA_QUALITY_PS > 7)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","#if (FXAA_QUALITY_PS > 8)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","#if (FXAA_QUALITY_PS > 9)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","#if (FXAA_QUALITY_PS > 10)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","#if (FXAA_QUALITY_PS > 11)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","#if (FXAA_QUALITY_PS > 12)","if(doneNP) {","if(!doneN) lumaEndN = dot(texture2D(tex, posN.xy).xyz, luma);","if(!doneP) lumaEndP = dot(texture2D(tex, posP.xy).xyz, luma);","if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","doneN = abs(lumaEndN) >= gradientScaled;","doneP = abs(lumaEndP) >= gradientScaled;","if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","doneNP = (!doneN) || (!doneP);","if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","#endif","}","float dstN = posM.x - posN.x;","float dstP = posP.x - posM.x;","if(!horzSpan) dstN = posM.y - posN.y;","if(!horzSpan) dstP = posP.y - posM.y;","bool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","float spanLength = (dstP + dstN);","bool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","float spanLengthRcp = 1.0 / spanLength;","bool directionN = dstN < dstP;","float dst = min(dstN, dstP);","bool goodSpan = directionN ? goodSpanN : goodSpanP;","float subpixG = subpixF * subpixF;","float pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","float subpixH = subpixG * subpixQuality;","float pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","float pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","// maybe return vec4(texture2D(tex, posM).xyz, lumaM);","return texture2D(tex, posM);","}","uniform sampler2D fbo_texture;","uniform vec2 resolution;","varying vec2 f_texcoord;","void main(void) {","gl_FragColor = fxaa(f_texcoord, fbo_texture, vec2(1.0 / resolution.x, 1.0 / resolution.y), 0.75, 0.166, 0.0833);","}"]),Lore.Octree=function(){function e(t,o){_classCallCheck(this,e),this.threshold=t||500,this.maxDepth=o||8,this.points={},this.aabbs={},this.offsets=[[-.5,-.5,-.5],[-.5,-.5,.5],[-.5,.5,-.5],[-.5,.5,.5],[.5,-.5,-.5],[.5,-.5,.5],[.5,.5,-.5],[.5,.5,.5]]}return _createClass(e,[{key:"build",value:function(e,t,o,n){n=n||1,o.setLocCode(n),this.points[n]=null,this.aabbs[n]=o;var i=this.getDepth(n);if(e.length<=this.threshold||i>=this.maxDepth){this.points[n]=new Uint32Array(e.length);for(var s=0;s<e.length;s++)this.points[n][s]=e[s];return!0}for(var r=new Uint32Array(8),a=new Float32Array(e.length),c=0;c<e.length;c++){var u=3*e[c];t[u+0]>=o.center.components[0]&&(a[c]|=4),t[u+1]>=o.center.components[1]&&(a[c]|=2),t[u+2]>=o.center.components[2]&&(a[c]|=1),r[a[c]]++}for(var l=new Array(8),h=new Array(8),f=0;f<8;f++)if(0!=r[f]){l[f]=new Uint32Array(r[f]);for(var m=0,p=0;m<e.length;m++)a[m]==f&&(l[f][p++]=e[m]);var d=this.offsets[f],v=new Lore.Vector3f(d[0],d[1],d[2]);v.multiplyScalar(o.radius),h[f]=new Lore.AABB(o.center.clone().add(v),.5*o.radius)}for(var y=0;y<8;y++)if(0!=r[y]){var g=this.generateLocCode(n,y);this.build(l[y],t,h[y],g)}return this}},{key:"getLocCodes",value:function(){return Object.keys(this.aabbs)}},{key:"getDepth",value:function(e){return Lore.Utils.msb(e)/3}},{key:"generateLocCode",value:function(e,t){return Lore.Utils.msb(e)==-1?8|t:(e=e<<=3)|t}},{key:"traverse",value:function(e,t){t=t||1;for(var o=0;o<8;o++){var n=t<<3|o;this.aabbs[n]&&(e(this.points[n],this.aabbs[n],n),this.traverse(e,n))}}},{key:"traverseIf",value:function(e,t,o){o=o||1;for(var n=0;n<8;n++){var i=o<<3|n;if(this.aabbs[i]){if(!t(this.aabbs[i],i))continue;e(this.points[i],this.aabbs[i],i),this.traverseIf(e,t,i)}}}},{key:"raySearch",value:function(e){var t=[];if(this.points[1])for(var o=0;o<this.points[1].length;o++)t.push({index:this.points[1][o],locCode:1});var n=e.ray.direction.clone();n.normalize();var i=new Lore.Vector3f(1,1,1);return i.divide(n),this.traverseIf(function(e,o,n){if(e)for(var i=0;i<e.length;i++)t.push({index:e[i],locCode:n})},function(t,o){return t.cylinderTest(e.ray.source,i,e.far,e.threshold)}),t}},{key:"getCenters",value:function(e){e=e||0;var t=new Array;return this.traverse(function(o,n,i){o&&o.length>e&&t.push(n.center)}),t}},{key:"getClosestBox",value:function(e,t,o){o=o||1;for(var n=-1,i=Number.MAX_VALUE,s=0;s<8;s++){var r=o<<3|s;if(this.aabbs[r]){if(this.points[r]&&this.points[r].length<t)continue;var a=this.aabbs[r].distanceToPointSq(e.components[0],e.components[1],e.components[2]);a<i&&(i=a,n=r)}}return n<0?this.aabbs[o]:this.getClosestBox(e,t,n)}},{key:"getClosestBoxFromCenter",value:function(e,t,o){o=o||1;for(var n=-1,i=Number.MAX_VALUE,s=0;s<8;s++){var r=o<<3|s;if(this.aabbs[r]){if(this.points[r]&&this.points[r].length<t)continue;var a=this.aabbs[r].distanceFromCenterToPointSq(e.components[0],e.components[1],e.components[2]);a<i&&(i=a,n=r)}}return n<0?this.aabbs[o]:this.getClosestBox(e,t,n)}},{key:"getFarthestBox",value:function(e,t,o){o=o||1;for(var n=-1,i=Number.MIN_VALUE,s=0;s<8;s++){var r=o<<3|s;if(this.aabbs[r]){if(this.points[r]&&this.points[r].length<t)continue;var a=this.aabbs[r].distanceToPointSq(e.components[0],e.components[1],e.components[2]);a>i&&(i=a,n=r)}}return n<0?this.aabbs[o]:this.getFarthestBox(e,t,n)}},{key:"getClosestPoint",value:function(e,t,o,n){o=o||0;var i=Number.MAX_VALUE,s=null,r=null;r=n?this.aabbs[n]:this.getClosestBox(e,o);var a=this.points[r.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var u=a[c];u*=3;var l=t[u],h=t[u+1],f=t[u+2],m=e.components,p=Math.pow(m[0]-l,2)+Math.pow(m[1]-h,2)+Math.pow(m[2]-f,2);p<i&&(i=p,s={x:l,y:h,z:f})}return s?new Lore.Vector3f(s.x,s.y,s.z):null}},{key:"getFarthestPoint",value:function(e,t,o,n){o=o||0;var i=Number.MIN_VALUE,s=null,r=null;r=n?this.aabbs[n]:this.getFArthestBox(e,o);var a=this.points[r.getLocCode()];if(!a)return null;for(var c=0;c<a.length;c++){var u=a[c];u*=3;var l=t[u],h=t[u+1],f=t[u+2],m=e.components,p=Math.pow(m[0]-l,2)+Math.pow(m[1]-h,2)+Math.pow(m[2]-f,2);p>i&&(i=p,s={x:l,y:h,z:f})}return s?new Lore.Vector3f(s.x,s.y,s.z):null}},{key:"getParent",value:function(e){return e>>>3}},{key:"getNeighbours",value:function(e){var t=this,o=new Array;return this.traverseIf(function(t,n,i){t&&t.length>0&&i!=e&&o.push(i)},function(o,n){return o.testAABB(t.aabbs[e])}),o}},{key:"kNearestNeighbours",value:function(e,t,o,n,i){e+=1;var s=n/3,r=t;if(!isNaN(parseFloat(t)))var a={x:n[3*a],y:n[3*a+1],z:n[3*a+2]};null===o&&(o=this.getClosestBoxFromCenter(new Lore.Vector3f(r.x,r.y,r.z),0).locCode);var c=this.getCellDistancesToPoint(r.x,r.y,r.z,o),u=this.pointDistancesSq(r.x,r.y,r.z,o,n),l=new RadixSort,h=l.sort(u.distancesSq,!0),f=l.sort(c.distancesSq,!0),m=0,p=0,d=new Uint32Array(e);console.log(h,f);for(var v=0;p<e&&v<h.array.length;v++){if(h.array[v]>f.array[0]){m=v;break}d[v]=u.indices[h.indices[v]],p++}if(p==e)return d;for(var y=0;y<f.array.length;y++){var g=c.locCodes[f.indices[y]],x=this.pointDistancesSq(r.x,r.y,r.z,g,n);u=Lore.Octree.mergePointDistances(u,x);for(var b=l.sort(u.distancesSq,!0),L=m;p<e&&L<b.array.length;L++){if(b.array[L]>f.array[y+1]){m=L;break}d[L]=u.indices[b.indices[L]],p++}if(p==e||p>=s-1)return d}return d}},{key:"getCellDistancesToPoint",value:function(e,t,o,n){var i=new Array;this.traverse(function(e,t,o){e&&e.length>0&&o!=n&&i.push(o)});for(var s=new Float32Array(i.length),r=0;r<i.length;r++)s[r]=this.aabbs[i[r]].distanceToPointSq(e,t,o);return{locCodes:i,distancesSq:s}}},{key:"expandNeighbourhood",value:function(e,t,o,n,i){for(var s=i.locCodes,r=i.distancesSq,a=s.length,c=a-1;c>=0;c--)for(var u=this.getNeighbours(s[c]),l=0;l<u.length;l++)u[l],u[l]==n||Lore.Utils.arrayContains(s,u[l])||s.push(u[l]);var h=s.length,f=r.length;if(h!=f){for(var m=new Float32Array(h-f),p=f,d=0;p<h;p++,d++)m[d]=this.aabbs[s[p]].distanceToPointSq(e,t,o);return i.distancesSq=Lore.Utils.concatTypedArrays(r,m),s.length-a}}},{key:"cellDistancesSq",value:function(e,t,o,n){for(var i=this.getNeighbours(n),s=new Float32Array(i.length),r=0;r<i.length;r++)s[r]=this.aabbs[i[r]].distanceToPointSq(e,t,o);return{locCodes:i,distancesSq:s}}},{key:"pointDistancesSq",value:function(e,t,o,n,i){for(var s=this.points[n],r=new Uint32Array(s.length),a=new Float32Array(s.length),c=0;c<s.length;c++){var u=3*s[c],l=i[u],h=i[u+1],f=i[u+2];r[c]=s[c],a[c]=Math.pow(l-e,2)+Math.pow(h-t,2)+Math.pow(f-o,2)}return{indices:r,distancesSq:a}}}],[{key:"concatTypedArrays",value:function(e,t){var o=new e.constructor(e.length+t.length);return o.set(e),o.set(t,e.length),o}},{key:"mergePointDistances",value:function(e,t){var o={};return o.indices=Lore.Octree.concatTypedArrays(e.indices,t.indices),o.distancesSq=Lore.Octree.concatTypedArrays(e.distancesSq,t.distancesSq),o}},{key:"mergeCellDistances",value:function(e,t){var o={};return o.locCodes=Lore.Octree.concatTypedArrays(e.locCodes,t.locCodes),o.distancesSq=Lore.Octree.concatTypedArrays(e.distancesSq,t.distancesSq),o}},{key:"clone",value:function e(t){var e=new Lore.Octree;e.threshold=t.threshold,e.maxDepth=t.maxDepth,e.points=t.points;for(var o in t.aabbs)t.aabbs.hasOwnProperty(o)&&(e.aabbs[o]=Lore.AABB.clone(t.aabbs[o]));return e}}]),e}(),Lore.AABB=function(){function e(t,o){_classCallCheck(this,e),this.center=t||new Lore.Vector3f,this.radius=o||0,this.locCode=0,this.left=0,this.right=0,this.back=0,this.front=0,this.bottom=0,this.top=0,this.neighbours=new Array(6),this.min=new Float32Array(3),this.max=new Float32Array(3),this.updateDimensions()}return _createClass(e,[{key:"updateDimensions",value:function(){var e=this.center.components[0],t=this.center.components[1],o=this.center.components[2];return this.min[0]=e-this.radius,this.min[1]=t-this.radius,this.min[2]=o-this.radius,this.max[0]=e+this.radius,this.max[1]=t+this.radius,this.max[2]=o+this.radius,this.left=e-this.radius,this.right=e+this.radius,this.back=o-this.radius,this.front=o+this.radius,this.bottom=t-this.radius,this.top=t+this.radius,this}},{key:"setLocCode",value:function(e){return this.locCode=e,this}},{key:"getLocCode",value:function(){return this.locCode}},{key:"rayTest",value:function(e,t,o){var n=e.components,i=t.components,s=(this.left-n[0])*i[0],r=(this.right-n[0])*i[0],a=(this.bottom-n[1])*i[1],c=(this.top-n[1])*i[1],u=(this.back-n[2])*i[2],l=(this.front-n[2])*i[2],h=Math.min(Math.max(s,r),Math.max(a,c),Math.max(u,l));if(h<0)return!1;var f=Math.max(Math.min(s,r),Math.min(a,c),Math.min(u,l));return!(f>h||f>o)}},{key:"cylinderTest",value:function(e,t,o,n){this.radius+=n,this.updateDimensions();var i=this.rayTest(e,t,o);return this.radius-=n,this.updateDimensions(),i}},{key:"distanceToPointSq",value:function(e,t,o){for(var n=0,i=[e,t,o],s=0;s<3;s++)i[s]<this.min[s]&&(n+=Math.pow(this.min[s]-i[s],2)),i[s]>this.max[s]&&(n+=Math.pow(i[s]-this.max[s],2));return n}},{key:"distanceFromCenterToPointSq",value:function(e,t,o){var n=this.center.components;return Math.pow(n[0]-e,2)+Math.pow(n[1]-t,2)+Math.pow(n[2]-o,2)}},{key:"testAABB",value:function(e){for(var t=0;t<3;t++)if(this.max[t]<e.min[t]||this.min[t]>e.max[t])return!1;return!0}}],[{key:"fromPoints",value:function(e){for(var t=e[0],o=e[1],n=e[2],i=new Lore.Vector3f(t,o,n),s=new Lore.Vector3f(t,o,n),r=i.components,a=s.components,c=1;c<e.length/3;c++)e[3*c+0]<r[0]&&(r[0]=e[3*c+0]),e[3*c+1]<r[1]&&(r[1]=e[3*c+1]),e[3*c+2]<r[2]&&(r[2]=e[3*c+2]),e[3*c+0]>a[0]&&(a[0]=e[3*c+0]),e[3*c+1]>a[1]&&(a[1]=e[3*c+1]),e[3*c+2]>a[2]&&(a[2]=e[3*c+2]);var u=new Lore.Vector3f.subtract(s,i);u.multiplyScalar(.5);var l=u.components[0],h=u.components[1],f=u.components[2],m=new Lore.Vector3f(l,h,f);m.add(i);var p=Math.max(l,h,f);return new Lore.AABB(m,p)}},{key:"getCorners",value:function(e){var t=e.center.components,o=t[0],n=t[1],i=t[2],s=e.radius;return[[o-s,n-s,i-s],[o-s,n-s,i+s],[o-s,n+s,i-s],[o-s,n+s,i+s],[o+s,n-s,i-s],[o+s,n-s,i+s],[o+s,n+s,i-s],[o+s,n+s,i+s]]}},{key:"clone",value:function e(t){var e=new Lore.AABB;return e.back=t.back,e.bottom=t.bottom,e.center=new Lore.Vector3f(t.center.components[0],t.center.components[1],t.center.components[2]),e.front=t.front,e.left=t.left,e.locCode=t.locCode,e.max=t.max,e.min=t.min,e.radius=t.radius,e.right=t.right,e.top=t.top,e}}]),e}(),Lore.Raycaster=function(){function e(){_classCallCheck(this,e),this.ray=new Lore.Ray,this.near=0,this.far=1e3,this.threshold=.1}return _createClass(e,[{key:"set",value:function(e,t,o){return this.near=e.near,this.far=e.far,this.ray.source.set(t,o,(e.near+e.far)/(e.near-e.far)),this.ray.source.unproject(e),this.ray.direction.set(0,0,-1),this.ray.direction.toDirection(e.modelMatrix),this}}]),e}(),Lore.UI=function(e){this.canvas=document.createElement("canvas"),this.renderCanvasElement=document.getElementById(e),this.init(),this.resize()},Lore.UI.prototype={constructor:Lore.UI,init:function(){this.canvas.style.cssText="position: absolute; pointer-events: none;",this.renderCanvasElement.parentNode.insertBefore(this.canvas,this.renderCanvasElement)},setWidth:function(e){this.canvas.width=e},setHeight:function(e){this.canvas.height=e},setTop:function(e){this.canvas.style.top=e},setLeft:function(e){this.canvas.style.left=e},resize:function(){this.setWidth(this.renderCanvasElement.width),this.setHeight(this.renderCanvasElement.height),this.setTop(this.renderCanvasElement.offsetTop),this.setLeft(this.renderCanvasElement.offsetLeft)}};